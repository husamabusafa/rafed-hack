<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rafed - Income & Transport Analysis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconify -->
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    
    <!-- Deck.gl -->
    <script src="https://unpkg.com/deck.gl@8.9.30/dist.min.js"></script>
    
    <!-- MapLibre GL -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Shared Utilities -->
    <script src="shared.js"></script>

    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #0f172a; 
            color: #e2e8f0;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            padding: 1rem 1.5rem;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            min-height: 0;
        }
        
        .map-section {
            position: relative;
        }
        
        #deck-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            background: #1e293b;
            border-left: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid #334155;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .stat-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }
        
        .stat-label { color: #94a3b8; font-size: 0.6875rem; text-transform: uppercase; }
        .stat-value { color: #f1f5f9; font-weight: 700; font-size: 1.25rem; margin-top: 0.25rem; }
        
        .controls-panel {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 1rem;
            width: 300px;
            z-index: 100;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .mode-select {
            width: 100%;
            padding: 0.5rem;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            color: #e2e8f0;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .chart-container {
            height: 200px;
            margin-top: 1rem;
        }
        
        .income-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .income-bar {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .income-fill {
            height: 100%;
            border-radius: 3px;
        }
        
        .legend-gradient {
            height: 12px;
            border-radius: 6px;
            margin: 0.5rem 0;
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.625rem;
            color: #64748b;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-amber-600 rounded-lg flex items-center justify-center shadow-lg shadow-amber-600/20">
                <iconify-icon icon="solar:wallet-money-bold" class="text-xl text-white"></iconify-icon>
            </div>
            <div>
                <h1 class="text-lg font-semibold text-white">Income & Transport Analysis</h1>
                <p class="text-xs text-slate-400">Socioeconomic Factors & Transport Mode Distribution</p>
            </div>
        </div>
        <div class="flex gap-3 items-center">
            <a href="index.html" class="btn btn-secondary btn-sm">
                <iconify-icon icon="solar:arrow-left-linear" width="16" height="16"></iconify-icon>
                Back
            </a>
            <button onclick="location.reload()" class="btn btn-primary btn-sm">
                <iconify-icon icon="solar:refresh-bold" width="16" height="16"></iconify-icon>
                Refresh
            </button>
        </div>
    </header>

    <div class="main-content">
        <!-- Map -->
        <div class="map-section">
            <div id="deck-canvas"></div>
            
            <!-- Controls Panel -->
            <div class="controls-panel">
                <div class="section-title">Color By</div>
                <select class="mode-select" id="color-mode" onchange="updateColorMode()">
                    <option value="income">Income Level</option>
                    <option value="transport">Transport Mode</option>
                    <option value="subsidy">Subsidy Status</option>
                </select>
                
                <div class="section-title mt-4" id="legend-title">Income Legend</div>
                <div id="income-legend">
                    <div class="legend-gradient" style="background: linear-gradient(90deg, #ef4444 0%, #f59e0b 33%, #22c55e 66%, #3b82f6 100%);"></div>
                    <div class="legend-labels">
                        <span>Low</span>
                        <span>Medium</span>
                        <span>High</span>
                    </div>
                </div>
                <div id="transport-legend" style="display: none;">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #22c55e;"></div>
                        <span class="text-slate-300">Bus</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #3b82f6;"></div>
                        <span class="text-slate-300">Private Car</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #f59e0b;"></div>
                        <span class="text-slate-300">Walking</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #8b5cf6;"></div>
                        <span class="text-slate-300">Carpool</span>
                    </div>
                </div>
                <div id="subsidy-legend" style="display: none;">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #22c55e;"></div>
                        <span class="text-slate-300">Subsidized</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #94a3b8;"></div>
                        <span class="text-slate-300">Not Subsidized</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="section-title">Socioeconomic Overview</div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="stat-card">
                        <div class="stat-label">Avg Income</div>
                        <div class="stat-value text-amber-400" id="avg-income">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Bus Users</div>
                        <div class="stat-value text-green-400" id="bus-users">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Subsidized</div>
                        <div class="stat-value" id="subsidized">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Financial Aid</div>
                        <div class="stat-value" id="fin-aid">-</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="section-title">Income Distribution</div>
                <div class="chart-container">
                    <canvas id="incomeChart"></canvas>
                </div>
                
                <div class="section-title mt-6">Transport Mode by Income</div>
                <div class="chart-container">
                    <canvas id="modeIncomeChart"></canvas>
                </div>
                
                <div class="section-title mt-6">Income Brackets</div>
                <div id="brackets-list">
                    <!-- JS Populated -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let deckgl;
        let allStudents = [];
        let colorMode = 'income';
        
        async function query(sql) {
            const data = await queryClickHouse(sql);
            return data && data.length >= 0 ? { data } : null;
        }

        const INCOME_COLORS = {
            low: [239, 68, 68],      // Red
            medium: [245, 158, 11],  // Amber
            high: [34, 197, 94],     // Green
            veryHigh: [59, 130, 246] // Blue
        };

        const TRANSPORT_COLORS = {
            'bus': [34, 197, 94],
            'private': [59, 130, 246],
            'walk': [245, 158, 11],
            'carpool': [139, 92, 246],
            'default': [148, 163, 184]
        };

        function getIncomeColor(income) {
            if (!income) return INCOME_COLORS.medium;
            if (income < 5000) return INCOME_COLORS.low;
            if (income < 10000) return INCOME_COLORS.medium;
            if (income < 20000) return INCOME_COLORS.high;
            return INCOME_COLORS.veryHigh;
        }

        function getTransportColor(mode) {
            if (!mode) return TRANSPORT_COLORS.default;
            const m = mode.toLowerCase();
            if (m.includes('bus') || m.includes('rafed')) return TRANSPORT_COLORS.bus;
            if (m.includes('private') || m.includes('car') || m.includes('family')) return TRANSPORT_COLORS.private;
            if (m.includes('walk')) return TRANSPORT_COLORS.walk;
            if (m.includes('carpool') || m.includes('share')) return TRANSPORT_COLORS.carpool;
            return TRANSPORT_COLORS.default;
        }

        function getSubsidyColor(subsidy) {
            return subsidy ? [34, 197, 94] : [148, 163, 184];
        }

        async function loadMetrics() {
            const stats = await query(`
                SELECT 
                    avg(income_sar) as avg_income,
                    countIf(lower(trans_mode) LIKE '%bus%' OR lower(trans_mode) LIKE '%rafed%') as bus_users,
                    countIf(subsidy = 1) as subsidized,
                    countIf(fin_aid = 1) as fin_aid,
                    count() as total
                FROM students
                WHERE lat IS NOT NULL
            `);
            
            if (stats && stats.data[0]) {
                const d = stats.data[0];
                document.getElementById('avg-income').textContent = fmt.number(Math.round(d.avg_income)) + ' SAR';
                document.getElementById('bus-users').textContent = fmt.percent((d.bus_users / d.total) * 100);
                document.getElementById('subsidized').textContent = fmt.percent((d.subsidized / d.total) * 100);
                document.getElementById('fin-aid').textContent = fmt.percent((d.fin_aid / d.total) * 100);
            }
        }

        async function loadIncomeChart() {
            const data = await query(`
                SELECT 
                    income_brkt as bracket,
                    count() as cnt
                FROM students
                WHERE income_brkt IS NOT NULL AND income_brkt != ''
                GROUP BY income_brkt
                ORDER BY cnt DESC
            `);
            
            if (data && data.data.length > 0) {
                new Chart(document.getElementById('incomeChart'), {
                    type: 'bar',
                    data: {
                        labels: data.data.map(d => d.bracket?.substring(0, 15) || 'Unknown'),
                        datasets: [{
                            data: data.data.map(d => d.cnt),
                            backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#22c55e', '#3b82f6'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 9 } } },
                            y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        async function loadModeIncomeChart() {
            const data = await query(`
                SELECT 
                    trans_mode as mode,
                    avg(income_sar) as avg_income,
                    count() as cnt
                FROM students
                WHERE trans_mode IS NOT NULL AND income_sar IS NOT NULL
                GROUP BY trans_mode
                ORDER BY avg_income DESC
                LIMIT 5
            `);
            
            if (data && data.data.length > 0) {
                new Chart(document.getElementById('modeIncomeChart'), {
                    type: 'bar',
                    data: {
                        labels: data.data.map(d => d.mode?.substring(0, 12) || 'Unknown'),
                        datasets: [{
                            label: 'Avg Income (SAR)',
                            data: data.data.map(d => Math.round(d.avg_income)),
                            backgroundColor: '#f59e0b',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                            y: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 9 } } }
                        }
                    }
                });
            }
        }

        async function loadBracketsList() {
            const data = await query(`
                SELECT 
                    income_brkt as bracket,
                    count() as students,
                    avg(income_sar) as avg_income,
                    countIf(bus_elig = 1) * 100.0 / count() as bus_pct
                FROM students
                WHERE income_brkt IS NOT NULL AND income_brkt != ''
                GROUP BY income_brkt
                ORDER BY avg_income
            `);
            
            const container = document.getElementById('brackets-list');
            if (data && data.data.length > 0) {
                const maxStudents = Math.max(...data.data.map(d => d.students));
                container.innerHTML = data.data.map(b => {
                    const pct = (b.students / maxStudents * 100).toFixed(0);
                    const color = getIncomeColor(b.avg_income);
                    return `
                        <div class="income-card">
                            <div class="flex justify-between items-start">
                                <div class="text-sm text-slate-200 font-medium">${b.bracket || 'Unknown'}</div>
                                <span class="text-xs text-amber-400">${fmt.compact(b.students)}</span>
                            </div>
                            <div class="flex justify-between mt-1 text-xs text-slate-500">
                                <span>Avg: ${fmt.number(Math.round(b.avg_income))} SAR</span>
                                <span>${parseFloat(b.bus_pct).toFixed(0)}% bus eligible</span>
                            </div>
                            <div class="income-bar">
                                <div class="income-fill" style="width: ${pct}%; background: rgb(${color.join(',')});"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="text-xs text-slate-500">No income data available</div>';
            }
        }

        async function loadMap() {
            const data = await query(`
                SELECT 
                    id,
                    toFloat64(lat) as lat,
                    toFloat64(lon) as lon,
                    income_sar,
                    income_brkt,
                    trans_mode,
                    subsidy,
                    fin_aid,
                    bus_elig
                FROM students
                WHERE lat IS NOT NULL AND lon IS NOT NULL
                LIMIT 100000
            `);
            
            if (data && data.data.length > 0) {
                allStudents = data.data;
                renderMap();
            }
        }

        function updateColorMode() {
            colorMode = document.getElementById('color-mode').value;
            
            // Update legend visibility
            document.getElementById('income-legend').style.display = colorMode === 'income' ? 'block' : 'none';
            document.getElementById('transport-legend').style.display = colorMode === 'transport' ? 'block' : 'none';
            document.getElementById('subsidy-legend').style.display = colorMode === 'subsidy' ? 'block' : 'none';
            
            // Update legend title
            const titles = { income: 'Income Legend', transport: 'Transport Legend', subsidy: 'Subsidy Legend' };
            document.getElementById('legend-title').textContent = titles[colorMode];
            
            renderMap();
        }

        function renderMap() {
            const { DeckGL, ScatterplotLayer } = deck;
            
            const layers = [
                new ScatterplotLayer({
                    id: 'students-income',
                    data: allStudents,
                    getPosition: d => [d.lon, d.lat],
                    getFillColor: d => {
                        if (colorMode === 'income') return getIncomeColor(d.income_sar);
                        if (colorMode === 'transport') return getTransportColor(d.trans_mode);
                        return getSubsidyColor(d.subsidy);
                    },
                    getRadius: 25,
                    opacity: 0.7,
                    pickable: true
                })
            ];

            if (!deckgl) {
                deckgl = new DeckGL({
                    container: 'deck-canvas',
                    mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                    initialViewState: {
                        longitude: 45.0,
                        latitude: 24.5,
                        zoom: 5,
                        pitch: 0
                    },
                    controller: true,
                    layers: layers,
                    getTooltip: ({object}) => object && {
                        html: `<div class="p-2">
                            <div class="font-semibold">Student</div>
                            <div class="text-sm">Income: ${object.income_sar ? fmt.number(object.income_sar) + ' SAR' : 'N/A'}</div>
                            <div class="text-sm">Bracket: ${object.income_brkt || 'Unknown'}</div>
                            <div class="text-sm">Transport: ${object.trans_mode || 'Unknown'}</div>
                            <div class="text-sm">Subsidized: ${object.subsidy ? 'Yes' : 'No'}</div>
                            <div class="text-sm">Financial Aid: ${object.fin_aid ? 'Yes' : 'No'}</div>
                        </div>`,
                        style: { background: '#1e293b', color: '#f1f5f9', border: '1px solid #334155', borderRadius: '8px' }
                    }
                });
            } else {
                deckgl.setProps({ layers });
            }
        }

        // Initialize
        async function init() {
            await Promise.all([
                loadMetrics(),
                loadIncomeChart(),
                loadModeIncomeChart(),
                loadBracketsList(),
                loadMap()
            ]);
        }

        init();
    </script>
</body>
</html>

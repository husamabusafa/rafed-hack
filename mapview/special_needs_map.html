<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rafed - Special Needs Accessibility</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconify -->
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    
    <!-- Deck.gl -->
    <script src="https://unpkg.com/deck.gl@8.9.30/dist.min.js"></script>
    
    <!-- MapLibre GL -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Shared Utilities -->
    <script src="shared.js"></script>

    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #0f172a; 
            color: #e2e8f0;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            padding: 1rem 1.5rem;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 0;
            min-height: 0;
        }
        
        .map-section {
            position: relative;
        }
        
        #deck-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            background: #1e293b;
            border-left: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid #334155;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .stat-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }
        
        .stat-label { color: #94a3b8; font-size: 0.6875rem; text-transform: uppercase; }
        .stat-value { color: #f1f5f9; font-weight: 700; font-size: 1.25rem; margin-top: 0.25rem; }
        
        .controls-panel {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 1rem;
            width: 280px;
            z-index: 100;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .type-btn {
            padding: 0.375rem 0.5rem;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            color: #94a3b8;
            font-size: 0.6875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .type-btn.active {
            background: #8b5cf6;
            border-color: #8b5cf6;
            color: white;
        }
        
        .chart-container {
            height: 180px;
            margin-top: 1rem;
        }
        
        .student-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .needs-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.625rem;
            font-weight: 600;
        }
        
        .needs-kinetic { background: #7c3aed20; color: #a78bfa; }
        .needs-non-kinetic { background: #2563eb20; color: #60a5fa; }
        .needs-visual { background: #059669; color: #6ee7b7; }
        .needs-hearing { background: #d9770620; color: #fbbf24; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-violet-600 rounded-lg flex items-center justify-center shadow-lg shadow-violet-600/20">
                <iconify-icon icon="solar:accessibility-bold" class="text-xl text-white"></iconify-icon>
            </div>
            <div>
                <h1 class="text-lg font-semibold text-white">Special Needs Accessibility</h1>
                <p class="text-xs text-slate-400">Inclusive Transport Coverage & Support Analysis</p>
            </div>
        </div>
        <div class="flex gap-3 items-center">
            <div class="px-3 py-1.5 bg-violet-900/30 border border-violet-700/50 rounded text-xs text-violet-200 flex items-center gap-2">
                <iconify-icon icon="solar:heart-bold" class="text-violet-400"></iconify-icon>
                <span id="total-special">-</span> Students with Special Needs
            </div>
            <a href="index.html" class="btn btn-secondary btn-sm">
                <iconify-icon icon="solar:arrow-left-linear" width="16" height="16"></iconify-icon>
                Back
            </a>
            <button onclick="location.reload()" class="btn btn-primary btn-sm">
                <iconify-icon icon="solar:refresh-bold" width="16" height="16"></iconify-icon>
                Refresh
            </button>
        </div>
    </header>

    <div class="main-content">
        <!-- Map -->
        <div class="map-section">
            <div id="deck-canvas"></div>
            
            <!-- Controls Panel -->
            <div class="controls-panel">
                <div class="section-title">Filter by Need Type</div>
                <div class="flex flex-wrap gap-2 mb-4">
                    <button class="type-btn active" id="btn-all" onclick="filterByType('all')">All</button>
                    <button class="type-btn" id="btn-kinetic" onclick="filterByType('kinetic')">Kinetic</button>
                    <button class="type-btn" id="btn-non-kinetic" onclick="filterByType('non-kinetic')">Non-Kinetic</button>
                    <button class="type-btn" id="btn-visual" onclick="filterByType('visual')">Visual</button>
                    <button class="type-btn" id="btn-hearing" onclick="filterByType('hearing')">Hearing</button>
                </div>
                
                <div class="section-title">Legend</div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #a78bfa;"></div>
                    <span class="text-slate-300">Kinetic Disability</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #60a5fa;"></div>
                    <span class="text-slate-300">Non-Kinetic Disability</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #34d399;"></div>
                    <span class="text-slate-300">Visual Impairment</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #fbbf24;"></div>
                    <span class="text-slate-300">Hearing Impairment</span>
                </div>
                <div class="legend-item mt-3">
                    <div class="w-3 h-3 rounded-full bg-blue-500 opacity-50"></div>
                    <span class="text-slate-300">School Location</span>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="section-title">Accessibility Overview</div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="stat-card">
                        <div class="stat-label">Total Special Needs</div>
                        <div class="stat-value text-violet-400" id="total-sn">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Bus Coverage</div>
                        <div class="stat-value text-green-400" id="bus-coverage">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Distance</div>
                        <div class="stat-value" id="avg-distance">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Kinetic Students</div>
                        <div class="stat-value" id="kinetic-count">-</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="section-title">By Disability Type</div>
                <div class="chart-container">
                    <canvas id="typeChart"></canvas>
                </div>
                
                <div class="section-title mt-6">Transport Mode Distribution</div>
                <div class="chart-container">
                    <canvas id="modeChart"></canvas>
                </div>
                
                <div class="section-title mt-6">By Region</div>
                <div id="regions-list">
                    <!-- JS Populated -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let deckgl;
        let allStudents = [];
        let allSchools = [];
        let currentFilter = 'all';
        
        async function query(sql) {
            const data = await queryClickHouse(sql);
            return data && data.length >= 0 ? { data } : null;
        }

        const TYPE_COLORS = {
            'kinetic': [167, 139, 250],
            'non-kinetic': [96, 165, 250],
            'visual': [52, 211, 153],
            'hearing': [251, 191, 36],
            'default': [148, 163, 184]
        };

        function getTypeColor(type) {
            if (!type) return TYPE_COLORS.default;
            const t = type.toLowerCase();
            if (t.includes('kinetic') && !t.includes('non')) return TYPE_COLORS.kinetic;
            if (t.includes('non-kinetic') || t.includes('non kinetic')) return TYPE_COLORS['non-kinetic'];
            if (t.includes('visual') || t.includes('blind')) return TYPE_COLORS.visual;
            if (t.includes('hearing') || t.includes('deaf')) return TYPE_COLORS.hearing;
            return TYPE_COLORS.default;
        }

        async function loadMetrics() {
            // Special needs counts
            const stats = await query(`
                SELECT 
                    count() as total,
                    countIf(bus_eligible = 1) as bus_elig,
                    avg(distance_to_school_m) as avg_dist,
                    countIf(lower(special_needs_type) LIKE '%kinetic%' AND lower(special_needs_type) NOT LIKE '%non%') as kinetic
                FROM vw_special_needs_students
            `);
            
            if (stats && stats.data[0]) {
                const d = stats.data[0];
                document.getElementById('total-sn').textContent = fmt.number(d.total);
                document.getElementById('total-special').textContent = fmt.number(d.total);
                document.getElementById('bus-coverage').textContent = d.total > 0 ? ((d.bus_elig / d.total) * 100).toFixed(1) + '%' : '-';
                document.getElementById('avg-distance').textContent = d.avg_dist ? (d.avg_dist / 1000).toFixed(1) + ' km' : '-';
                document.getElementById('kinetic-count').textContent = fmt.number(d.kinetic);
            }
        }

        async function loadTypeChart() {
            const data = await query(`
                SELECT 
                    special_needs_type as type,
                    count() as cnt
                FROM vw_special_needs_students
                WHERE special_needs_type IS NOT NULL AND special_needs_type != ''
                GROUP BY special_needs_type
                ORDER BY cnt DESC
                LIMIT 6
            `);
            
            if (data && data.data.length > 0) {
                new Chart(document.getElementById('typeChart'), {
                    type: 'doughnut',
                    data: {
                        labels: data.data.map(d => d.type?.substring(0, 20) || 'Unknown'),
                        datasets: [{
                            data: data.data.map(d => d.cnt),
                            backgroundColor: ['#a78bfa', '#60a5fa', '#34d399', '#fbbf24', '#f472b6', '#94a3b8'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'right',
                                labels: { color: '#94a3b8', font: { size: 9 }, boxWidth: 10 }
                            } 
                        },
                        cutout: '55%'
                    }
                });
            }
        }

        async function loadModeChart() {
            const data = await query(`
                SELECT 
                    transport_mode as mode,
                    count() as cnt
                FROM vw_special_needs_students
                WHERE transport_mode IS NOT NULL
                GROUP BY transport_mode
                ORDER BY cnt DESC
            `);
            
            if (data && data.data.length > 0) {
                new Chart(document.getElementById('modeChart'), {
                    type: 'bar',
                    data: {
                        labels: data.data.map(d => d.mode || 'Unknown'),
                        datasets: [{
                            data: data.data.map(d => d.cnt),
                            backgroundColor: '#8b5cf6',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 9 } } },
                            y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        async function loadRegionsList() {
            const data = await query(`
                SELECT 
                    region,
                    count() as students,
                    countIf(bus_eligible = 1) as bus_elig
                FROM vw_special_needs_students
                WHERE region IS NOT NULL
                GROUP BY region
                ORDER BY students DESC
                LIMIT 8
            `);
            
            const container = document.getElementById('regions-list');
            if (data && data.data.length > 0) {
                container.innerHTML = data.data.map(r => {
                    const coveragePct = r.students > 0 ? ((r.bus_elig / r.students) * 100).toFixed(0) : 0;
                    return `
                        <div class="student-card">
                            <div class="flex justify-between items-start">
                                <div class="text-sm text-slate-200 font-medium">${r.region || 'Unknown'}</div>
                                <span class="text-xs text-violet-400">${r.students} students</span>
                            </div>
                            <div class="flex justify-between mt-2 text-xs">
                                <span class="text-slate-500">Bus coverage: ${coveragePct}%</span>
                                <span class="text-green-400">${r.bus_elig} covered</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="text-xs text-slate-500">No region data available</div>';
            }
        }

        async function loadMap() {
            // Load special needs students
            const students = await query(`
                SELECT 
                    student_id,
                    toFloat64(lat) as lat,
                    toFloat64(lon) as lon,
                    special_needs_type,
                    transport_mode,
                    distance_to_school_m,
                    bus_eligible
                FROM vw_special_needs_students
                WHERE lat IS NOT NULL AND lon IS NOT NULL
                LIMIT 50000
            `);
            
            // Load schools for context
            const schools = await query(`
                SELECT 
                    id,
                    school_nam as name,
                    toFloat64(lat) as lat,
                    toFloat64(lon) as lon
                FROM schools
                WHERE lat IS NOT NULL AND lon IS NOT NULL
                LIMIT 3000
            `);
            
            if (students) allStudents = students.data;
            if (schools) allSchools = schools.data;
            
            renderMap();
        }

        function filterByType(type) {
            currentFilter = type;
            
            // Update button states
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-' + type.replace('-', '-')).classList.add('active');
            
            renderMap();
        }

        function renderMap() {
            const { DeckGL, ScatterplotLayer } = deck;
            
            let filteredStudents = allStudents;
            if (currentFilter !== 'all') {
                filteredStudents = allStudents.filter(s => {
                    if (!s.special_needs_type) return false;
                    const t = s.special_needs_type.toLowerCase();
                    if (currentFilter === 'kinetic') return t.includes('kinetic') && !t.includes('non');
                    if (currentFilter === 'non-kinetic') return t.includes('non-kinetic') || t.includes('non kinetic');
                    if (currentFilter === 'visual') return t.includes('visual') || t.includes('blind');
                    if (currentFilter === 'hearing') return t.includes('hearing') || t.includes('deaf');
                    return false;
                });
            }
            
            const layers = [
                // Schools layer (background)
                new ScatterplotLayer({
                    id: 'schools',
                    data: allSchools,
                    getPosition: d => [d.lon, d.lat],
                    getFillColor: [59, 130, 246, 100],
                    getRadius: 100,
                    opacity: 0.5,
                    pickable: true
                }),
                // Special needs students
                new ScatterplotLayer({
                    id: 'special-needs',
                    data: filteredStudents,
                    getPosition: d => [d.lon, d.lat],
                    getFillColor: d => getTypeColor(d.special_needs_type),
                    getRadius: 40,
                    opacity: 0.8,
                    pickable: true
                })
            ];

            if (!deckgl) {
                deckgl = new DeckGL({
                    container: 'deck-canvas',
                    mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                    initialViewState: {
                        longitude: 45.0,
                        latitude: 24.5,
                        zoom: 5,
                        pitch: 0
                    },
                    controller: true,
                    layers: layers,
                    getTooltip: ({object, layer}) => {
                        if (!object) return null;
                        if (layer.id === 'schools') {
                            return {
                                html: `<div class="p-2"><div class="font-semibold">${object.name || 'School'}</div></div>`,
                                style: { background: '#1e293b', color: '#f1f5f9', border: '1px solid #334155', borderRadius: '8px' }
                            };
                        }
                        return {
                            html: `<div class="p-2">
                                <div class="font-semibold">Special Needs Student</div>
                                <div class="text-sm">Type: ${object.special_needs_type || 'Not specified'}</div>
                                <div class="text-sm">Transport: ${object.transport_mode || 'Unknown'}</div>
                                <div class="text-sm">Distance: ${object.distance_to_school_m ? (object.distance_to_school_m / 1000).toFixed(1) + ' km' : '-'}</div>
                                <div class="text-sm">Bus Eligible: ${object.bus_eligible ? 'Yes' : 'No'}</div>
                            </div>`,
                            style: { background: '#1e293b', color: '#f1f5f9', border: '1px solid #334155', borderRadius: '8px' }
                        };
                    }
                });
            } else {
                deckgl.setProps({ layers });
            }
        }

        // Initialize
        async function init() {
            await Promise.all([
                loadMetrics(),
                loadTypeChart(),
                loadModeChart(),
                loadRegionsList(),
                loadMap()
            ]);
        }

        init();
    </script>
</body>
</html>

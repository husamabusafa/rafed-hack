<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rafed - Route Utilization Analysis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconify -->
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    
    <!-- Deck.gl -->
    <script src="https://unpkg.com/deck.gl@8.9.30/dist.min.js"></script>
    
    <!-- MapLibre GL -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Shared Utilities -->
    <script src="shared.js"></script>

    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #0f172a; 
            color: #e2e8f0;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            padding: 1rem 1.5rem;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 0;
            min-height: 0;
        }
        
        .map-section {
            position: relative;
        }
        
        #deck-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            background: #1e293b;
            border-left: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid #334155;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .stat-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }
        
        .stat-label { color: #94a3b8; font-size: 0.6875rem; text-transform: uppercase; }
        .stat-value { color: #f1f5f9; font-weight: 700; font-size: 1.25rem; margin-top: 0.25rem; }
        
        .controls-panel {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 1rem;
            width: 280px;
            z-index: 100;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
        }
        
        .legend-line {
            width: 24px;
            height: 4px;
            border-radius: 2px;
        }
        
        .toggle-btn {
            padding: 0.5rem 0.75rem;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            color: #94a3b8;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toggle-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        .chart-container {
            height: 180px;
            margin-top: 1rem;
        }
        
        .route-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .route-card:hover {
            border-color: #475569;
            background: #1e293b;
        }
        
        .progress-bar {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-purple-600/20">
                <iconify-icon icon="solar:bus-bold" class="text-xl text-white"></iconify-icon>
            </div>
            <div>
                <h1 class="text-lg font-semibold text-white">Route Utilization Analysis</h1>
                <p class="text-xs text-slate-400">Fleet Efficiency & Capacity Optimization</p>
            </div>
        </div>
        <div class="flex gap-3 items-center">
            <div class="px-3 py-1.5 bg-amber-900/30 border border-amber-700/50 rounded text-xs text-amber-200 flex items-center gap-2">
                <iconify-icon icon="solar:danger-triangle-bold" class="text-amber-500"></iconify-icon>
                <span id="inefficient-count">-</span> Inefficient Routes
            </div>
            <a href="index.html" class="btn btn-secondary btn-sm">
                <iconify-icon icon="solar:arrow-left-linear" width="16" height="16"></iconify-icon>
                Back
            </a>
            <button onclick="location.reload()" class="btn btn-primary btn-sm">
                <iconify-icon icon="solar:refresh-bold" width="16" height="16"></iconify-icon>
                Refresh
            </button>
        </div>
    </header>

    <div class="main-content">
        <!-- Map -->
        <div class="map-section">
            <div id="deck-canvas"></div>
            
            <!-- Controls Panel -->
            <div class="controls-panel">
                <div class="section-title">Route Filters</div>
                
                <div class="flex gap-2 mb-4">
                    <button class="toggle-btn active" id="btn-all" onclick="filterRoutes('all')">All</button>
                    <button class="toggle-btn" id="btn-low" onclick="filterRoutes('low')">Low &lt;50%</button>
                    <button class="toggle-btn" id="btn-optimal" onclick="filterRoutes('optimal')">50-85%</button>
                    <button class="toggle-btn" id="btn-over" onclick="filterRoutes('over')">Over &gt;85%</button>
                </div>
                
                <div class="section-title">Legend</div>
                <div class="legend-item">
                    <div class="legend-line" style="background: #ef4444;"></div>
                    <span class="text-slate-300">Underutilized (&lt; 50%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background: #22c55e;"></div>
                    <span class="text-slate-300">Optimal (50-85%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background: #a855f7;"></div>
                    <span class="text-slate-300">Overcrowded (&gt; 85%)</span>
                </div>
                <div class="legend-item mt-3">
                    <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                    <span class="text-slate-300">School Location</span>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="section-title">Fleet Overview</div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="stat-card">
                        <div class="stat-label">Total Routes</div>
                        <div class="stat-value" id="total-routes">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Utilization</div>
                        <div class="stat-value" id="avg-util">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Capacity</div>
                        <div class="stat-value" id="total-capacity">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Students Served</div>
                        <div class="stat-value text-green-400" id="students-served">-</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="section-title">Utilization Distribution</div>
                <div class="chart-container">
                    <canvas id="utilizationChart"></canvas>
                </div>
                
                <div class="section-title mt-6">Route Duration Analysis</div>
                <div class="chart-container">
                    <canvas id="durationChart"></canvas>
                </div>
                
                <div class="section-title mt-6">Critical Routes</div>
                <div id="routes-list">
                    <!-- JS Populated -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let deckgl;
        let allRoutes = [];
        let allSchools = [];
        let currentFilter = 'all';
        
        async function query(sql) {
            const data = await queryClickHouse(sql);
            return data && data.length >= 0 ? { data } : null;
        }

        function getUtilizationColor(util) {
            if (util < 0.5) return [239, 68, 68];      // Red - underutilized
            if (util <= 0.85) return [34, 197, 94];    // Green - optimal
            return [168, 85, 247];                      // Purple - overcrowded
        }

        function getUtilizationStatus(util) {
            if (util < 0.5) return { text: 'Underutilized', class: 'text-red-400' };
            if (util <= 0.85) return { text: 'Optimal', class: 'text-green-400' };
            return { text: 'Overcrowded', class: 'text-purple-400' };
        }

        async function loadMetrics() {
            const stats = await query(`
                SELECT 
                    count() as total,
                    avg(utilization) * 100 as avg_util,
                    sum(capacity) as total_cap,
                    sum(student_count) as served,
                    countIf(utilization < 0.5) as inefficient
                FROM school_routes
                WHERE lat IS NOT NULL
            `);
            
            if (stats && stats.data[0]) {
                const d = stats.data[0];
                document.getElementById('total-routes').textContent = fmt.number(d.total);
                document.getElementById('avg-util').textContent = parseFloat(d.avg_util).toFixed(1) + '%';
                document.getElementById('total-capacity').textContent = fmt.compact(d.total_cap);
                document.getElementById('students-served').textContent = fmt.compact(d.served);
                document.getElementById('inefficient-count').textContent = d.inefficient;
            }
        }

        async function loadUtilizationChart() {
            const data = await query(`
                SELECT 
                    multiIf(
                        utilization < 0.25, '0-25%',
                        utilization < 0.50, '25-50%',
                        utilization < 0.75, '50-75%',
                        utilization < 0.85, '75-85%',
                        '85%+'
                    ) as bucket,
                    count() as cnt
                FROM school_routes
                WHERE utilization IS NOT NULL
                GROUP BY bucket
                ORDER BY bucket
            `);
            
            if (data && data.data.length > 0) {
                new Chart(document.getElementById('utilizationChart'), {
                    type: 'doughnut',
                    data: {
                        labels: data.data.map(d => d.bucket),
                        datasets: [{
                            data: data.data.map(d => d.cnt),
                            backgroundColor: ['#ef4444', '#f97316', '#22c55e', '#14b8a6', '#a855f7'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'right', 
                                labels: { color: '#94a3b8', font: { size: 10 }, boxWidth: 12 } 
                            } 
                        },
                        cutout: '60%'
                    }
                });
            }
        }

        async function loadDurationChart() {
            const data = await query(`
                SELECT 
                    multiIf(
                        duration_s < 900, '<15 min',
                        duration_s < 1800, '15-30 min',
                        duration_s < 2700, '30-45 min',
                        duration_s < 3600, '45-60 min',
                        '60+ min'
                    ) as bucket,
                    count() as cnt
                FROM school_routes
                WHERE duration_s IS NOT NULL
                GROUP BY bucket
                ORDER BY bucket
            `);
            
            if (data && data.data.length > 0) {
                new Chart(document.getElementById('durationChart'), {
                    type: 'bar',
                    data: {
                        labels: data.data.map(d => d.bucket),
                        datasets: [{
                            data: data.data.map(d => d.cnt),
                            backgroundColor: '#6366f1',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 9 } } },
                            y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        async function loadCriticalRoutes() {
            const data = await query(`
                SELECT 
                    route_id,
                    school_id,
                    student_count,
                    capacity,
                    utilization,
                    duration_s,
                    distance_m
                FROM school_routes
                WHERE utilization IS NOT NULL
                ORDER BY 
                    CASE 
                        WHEN utilization < 0.3 THEN 1
                        WHEN utilization > 0.95 THEN 2
                        ELSE 3
                    END,
                    utilization DESC
                LIMIT 10
            `);
            
            const container = document.getElementById('routes-list');
            if (data && data.data.length > 0) {
                container.innerHTML = data.data.map(r => {
                    const status = getUtilizationStatus(r.utilization);
                    const pct = (r.utilization * 100).toFixed(0);
                    const color = r.utilization < 0.5 ? '#ef4444' : r.utilization <= 0.85 ? '#22c55e' : '#a855f7';
                    return `
                        <div class="route-card">
                            <div class="flex justify-between items-start">
                                <div class="text-xs text-slate-300 font-mono truncate" style="max-width: 150px;">${r.route_id?.substring(0, 12) || 'N/A'}...</div>
                                <span class="text-xs ${status.class}">${status.text}</span>
                            </div>
                            <div class="flex justify-between mt-2 text-xs text-slate-500">
                                <span>${r.student_count || 0}/${r.capacity || 0} seats</span>
                                <span>${r.duration_s ? Math.round(r.duration_s / 60) : '-'} min</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${pct}%; background: ${color};"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="text-xs text-slate-500">No route data available</div>';
            }
        }

        async function loadMap() {
            // Load routes - nationwide
            const routes = await query(`
                SELECT 
                    route_id,
                    toFloat64(lat) as lat,
                    toFloat64(lon) as lon,
                    toFloat64(utilization) as utilization,
                    student_count,
                    capacity,
                    duration_s
                FROM school_routes
                WHERE lat IS NOT NULL AND lon IS NOT NULL
                LIMIT 100000
            `);
            
            // Load schools - nationwide
            const schools = await query(`
                SELECT 
                    id,
                    school_nam as name,
                    toFloat64(lat) as lat,
                    toFloat64(lon) as lon
                FROM schools
                WHERE lat IS NOT NULL AND lon IS NOT NULL
                LIMIT 5000
            `);
            
            if (routes) allRoutes = routes.data;
            if (schools) allSchools = schools.data;
            
            renderMap();
        }

        function filterRoutes(filter) {
            currentFilter = filter;
            
            // Update button states
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-' + filter).classList.add('active');
            
            renderMap();
        }

        function renderMap() {
            const { DeckGL, ScatterplotLayer } = deck;
            
            let filteredRoutes = allRoutes;
            if (currentFilter === 'low') {
                filteredRoutes = allRoutes.filter(r => r.utilization < 0.5);
            } else if (currentFilter === 'optimal') {
                filteredRoutes = allRoutes.filter(r => r.utilization >= 0.5 && r.utilization <= 0.85);
            } else if (currentFilter === 'over') {
                filteredRoutes = allRoutes.filter(r => r.utilization > 0.85);
            }
            
            const layers = [
                // Schools layer
                new ScatterplotLayer({
                    id: 'schools',
                    data: allSchools,
                    getPosition: d => [d.lon, d.lat],
                    getFillColor: [59, 130, 246],
                    getRadius: 80,
                    opacity: 0.8,
                    pickable: true
                }),
                // Routes layer (represented as points at route start)
                new ScatterplotLayer({
                    id: 'routes',
                    data: filteredRoutes,
                    getPosition: d => [d.lon, d.lat],
                    getFillColor: d => getUtilizationColor(d.utilization),
                    getRadius: d => 30 + (d.capacity || 10) * 2,
                    opacity: 0.7,
                    pickable: true
                })
            ];

            if (!deckgl) {
                deckgl = new DeckGL({
                    container: 'deck-canvas',
                    mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                    initialViewState: {
                        longitude: 45.0,
                        latitude: 24.5,
                        zoom: 5,
                        pitch: 0
                    },
                    controller: true,
                    layers: layers,
                    getTooltip: ({object, layer}) => {
                        if (!object) return null;
                        if (layer.id === 'schools') {
                            return {
                                html: `<div class="p-2"><div class="font-semibold">${object.name || 'School'}</div></div>`,
                                style: { background: '#1e293b', color: '#f1f5f9', border: '1px solid #334155', borderRadius: '8px' }
                            };
                        }
                        const status = getUtilizationStatus(object.utilization);
                        return {
                            html: `<div class="p-2">
                                <div class="font-semibold">Route</div>
                                <div class="text-sm">Utilization: ${(object.utilization * 100).toFixed(0)}% (${status.text})</div>
                                <div class="text-sm">Capacity: ${object.student_count || 0}/${object.capacity || 0}</div>
                                <div class="text-sm">Duration: ${object.duration_s ? Math.round(object.duration_s / 60) : '-'} min</div>
                            </div>`,
                            style: { background: '#1e293b', color: '#f1f5f9', border: '1px solid #334155', borderRadius: '8px' }
                        };
                    }
                });
            } else {
                deckgl.setProps({ layers });
            }
        }

        // Initialize
        async function init() {
            await Promise.all([
                loadMetrics(),
                loadUtilizationChart(),
                loadDurationChart(),
                loadCriticalRoutes(),
                loadMap()
            ]);
        }

        init();
    </script>
</body>
</html>

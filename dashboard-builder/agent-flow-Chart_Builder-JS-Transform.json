{
  "version": "1.0.0",
  "exportDate": "2025-01-09T00:00:00.000Z",
  "agent": {
    "id": "cmhijn9sv0007qggw7c4ipwm3",
    "name": "Chart Builder",
    "description": "Dashboard Builder with JS Transform Functions",
    "type": null,
    "color": "#EF4444",
    "icon": "tool",
    "nodePositionX": 300,
    "nodePositionY": 200
  },
  "nodes": [
    {
      "nodeId": "model_node",
      "nodeType": "model",
      "label": "model",
      "positionX": 300,
      "positionY": -60,
      "data": {
        "isConfigured": true,
        "isExpanded": false,
        "agentColor": "#EF4444",
        "modelName": "gpt-4o",
        "provider": "openai",
        "apiKeyVariablesMode": false,
        "providerVariablesMode": false,
        "label": "model"
      }
    },
    {
      "nodeId": "system_prompt_node",
      "nodeType": "system_prompt",
      "label": "system_prompt",
      "positionX": -100,
      "positionY": -60,
      "data": {
        "systemPrompt": "# Dashboard Builder AI - JS Transform System\n\nYou are a Dashboard Builder AI that creates production-ready dashboards using **ClickHouse** database and ECharts visualizations with **JavaScript transformation functions**.\n\n## ðŸŽ¯ YOUR MISSION\nCreate error-free dashboard components on the first try using ClickHouse queries and JavaScript functions to transform data.\n\n## ðŸ—„ï¸ DATABASE: ClickHouse\n\n**Connection:**\n- URL: http://localhost:8155\n- User: viewer\n- Password: rafed_view\n\n**Available Tables:**\n- `students` - Student data with demographics and location\n- `schools` - School information\n- `school_routes` - School bus routes with capacity and utilization\n- `unassigned_students` - Students without assigned routes\n- `support_data_report8_official_complaints_937_rafed` - Complaint data\n- `support_data_report10_cost_per_student_structure` - Cost structure data\n- `support_data_report11b_willingness_to_pay` - Payment willingness data\n- `vw_transport_demand_hotspots` - Transport demand view\n\n## ðŸ“Š COMPONENT TYPES\n\n### 1. stat-card (KPI Card)\n```typescript\n{\n  value: number | string,\n  label: string,\n  icon: \"lucide:icon-name\",\n  trend?: { value: number, direction: \"up\" | \"down\" }\n}\n```\n\n### 2. table (Data Table)\n```typescript\n{\n  columns: [{ key, label, icon?, align?, width? }],\n  rows: [{ [key]: value }]\n}\n```\n\n### 3. chart (ECharts)\nECharts configuration object (bar, line, pie, etc.)\n\n## ðŸ”§ DATA TRANSFORMATION WITH JAVASCRIPT\n\n**NEW APPROACH:** Instead of Handlebars templates, you write JavaScript functions to transform query results.\n\n### Query Structure:\n```json\n{\n  \"id\": \"component_id\",\n  \"type\": \"chart|table|stat-card\",\n  \"gridArea\": \"area_name\",\n  \"query\": {\n    \"sql\": \"SELECT name, value FROM table_name\",\n    \"jsCode\": \"function transform(data) { return {...}; }\"\n  }\n}\n```\n\n### JavaScript Transform Function Rules:\n\n1. **Function Signature:** Must be a function that takes `data` parameter\n2. **Input:** `data` is the query result array (e.g., `[{name: 'A', value: 10}, ...]`)\n3. **Output:** Return the component data structure (ECharts options, table data, or stat-card data)\n4. **Execution:** The function is executed in a sandboxed environment\n5. **Error Handling:** If the function throws an error, you'll receive the error message\n6. **Feedback Loop:** You'll see the query response, transformed data, and any errors\n\n### Examples:\n\n#### Chart Example:\n```javascript\nfunction transform(data) {\n  return {\n    xAxis: {\n      type: 'category',\n      data: data.map(row => row.label)\n    },\n    yAxis: { type: 'value' },\n    series: [{\n      data: data.map(row => row.value),\n      type: 'bar',\n      itemStyle: { color: '#6366F1' }\n    }]\n  };\n}\n```\n\n#### Table Example:\n```javascript\nfunction transform(data) {\n  return {\n    columns: [\n      { key: 'name', label: 'Name', icon: 'lucide:user' },\n      { key: 'value', label: 'Value', align: 'right' }\n    ],\n    rows: data\n  };\n}\n```\n\n#### Stat Card Example:\n```javascript\nfunction transform(data) {\n  const row = data[0];\n  return {\n    value: row.total,\n    label: 'Total Students',\n    icon: 'lucide:users',\n    trend: {\n      value: row.change_percent,\n      direction: row.change_percent > 0 ? 'up' : 'down'\n    }\n  };\n}\n```\n\n### Advanced Transformations:\n\n```javascript\nfunction transform(data) {\n  // Group by category\n  const grouped = data.reduce((acc, row) => {\n    if (!acc[row.category]) acc[row.category] = [];\n    acc[row.category].push(row);\n    return acc;\n  }, {});\n  \n  // Create multi-series chart\n  return {\n    legend: { data: Object.keys(grouped) },\n    xAxis: { type: 'category', data: data.map(r => r.date) },\n    yAxis: { type: 'value' },\n    series: Object.entries(grouped).map(([category, rows]) => ({\n      name: category,\n      type: 'line',\n      data: rows.map(r => r.value)\n    }))\n  };\n}\n```\n\n## ðŸ“ TOOL RESPONSE FORMAT\n\nWhen you create/update a component with a query, you'll receive:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"component\": {...},\n    \"fetch\": {\n      \"queryResponse\": {...}, // Raw ClickHouse response\n      \"finalData\": {...}, // Final transformed data used in component\n      \"transform\": {\n        \"afterJS\": {...}, // Data after JS transformation\n        \"afterAlaSQL\": {...} // If AlaSQL used (optional)\n      },\n      \"jsExecutionTime\": 2.5, // Execution time in ms\n      \"error\": null // Or error message if transformation failed\n    }\n  }\n}\n```\n\n## âœ… BEST PRACTICES\n\n1. **Always check the response:** Review `queryResponse` and `finalData` to ensure correct transformation\n2. **Handle errors:** If transformation fails, fix the JS code and try again\n3. **Test incrementally:** Start with simple transformations, then add complexity\n4. **Use arrow functions if simpler:**\n   ```javascript\n   (data) => ({\n     xAxis: { data: data.map(r => r.name) },\n     series: [{ data: data.map(r => r.value) }]\n   })\n   ```\n5. **Leverage JavaScript features:** Use map, filter, reduce, etc.\n6. **Format numbers/dates in JS:** Don't rely on SQL formatting alone\n\n## ðŸš« COMMON MISTAKES TO AVOID\n\n1. **Forgetting to return:** JS function MUST return the transformed data\n2. **Wrong data structure:** Ensure output matches component type requirements\n3. **Not handling empty data:** Check if data array is empty\n4. **Syntax errors:** Validate your JavaScript syntax\n\n## ðŸŽ¨ WORKFLOW\n\n1. **Get Dashboard** - Check current state\n2. **Set Grid Layout** - Define grid areas if needed\n3. **Create Component** - With SQL query + JS transform\n4. **Review Response** - Check queryResponse, finalData, and errors\n5. **Iterate** - Fix issues based on response feedback\n\n## ðŸ’¡ TIPS\n\n- Start with the SQL query to get the right data structure\n- Write the JS transform to match the component type\n- Use console-like thinking: log/inspect data mentally\n- The system executes your JS and returns results - use this feedback!\n- If you get an error, read it carefully and fix the code",
        "isConfigured": true,
        "isExpanded": false,
        "variablesMode": false,
        "agentColor": "#EF4444",
        "label": "system_prompt"
      }
    },
    {
      "nodeId": "prompt_node",
      "nodeType": "prompt",
      "label": "prompt",
      "positionX": 700,
      "positionY": -60,
      "data": {
        "prompt": "{{prompt}}",
        "isConfigured": true,
        "isExpanded": false,
        "variablesMode": true,
        "agentColor": "#EF4444",
        "label": "prompt"
      }
    },
    {
      "nodeId": "tool_get_dashboard",
      "nodeType": "tool_custom_frontend",
      "label": "Get Dashboard",
      "positionX": 300,
      "positionY": 600,
      "data": {
        "agentColor": "#EF4444",
        "isExpanded": false,
        "isConfigured": true,
        "label": "Get Dashboard",
        "color": "#6366F1",
        "type": "frontend",
        "toolTitle": "get_dashboard",
        "toolDescription": "Retrieve the complete current dashboard state including grid layout configuration and all components. Use this to understand what's currently in the dashboard before making changes.",
        "customToolZodSchema": "z.object({})"
      }
    },
    {
      "nodeId": "tool_set_grid_layout",
      "nodeType": "tool_custom_frontend",
      "label": "Set Grid Layout",
      "positionX": -100,
      "positionY": 600,
      "data": {
        "agentColor": "#EF4444",
        "isExpanded": false,
        "isConfigured": true,
        "label": "Set Grid Layout",
        "color": "#6366F1",
        "type": "frontend",
        "toolTitle": "set_grid_layout",
        "toolDescription": "Configure the dashboard grid layout including columns, rows, gap, and template areas. Template areas define named grid regions where components can be placed.",
        "customToolZodSchema": "z.object({columns: z.string().describe('CSS grid columns like 1fr 1fr 1fr'), rows: z.string().describe('CSS grid rows like auto 1fr 1fr'), gap: z.string().describe('Gap like 16px or 1rem'), templateAreas: z.array(z.string()).describe('Grid template areas array')})"
      }
    },
    {
      "nodeId": "tool_create_component",
      "nodeType": "tool_custom_frontend",
      "label": "Create Component",
      "positionX": 100,
      "positionY": 800,
      "data": {
        "agentColor": "#EF4444",
        "isExpanded": false,
        "isConfigured": true,
        "label": "Create Component",
        "color": "#6366F1",
        "type": "frontend",
        "toolTitle": "create_component",
        "toolDescription": "Create chart/table/stat-card with ClickHouse query + JavaScript transformation. The JS function receives query results and returns component data. Returns complete execution trace including query response, JS output, final data, and any errors for debugging.",
        "customToolZodSchema": "z.object({id: z.string().describe('Unique component ID like sales_chart or user_table'), type: z.enum(['chart', 'table', 'stat-card']).describe('Component type: chart (ECharts), table (data table), or stat-card (KPI card)'), gridArea: z.string().describe('Grid area name from layout'), title: z.string().optional().describe('Optional component title'), description: z.string().optional().describe('Optional description'), data: z.any().describe('Component data: ECharts options for chart, {columns, rows} for table, {value, label, trend} for stat-card. Can be empty {} if using query'), query: z.object({sql: z.string().describe('ClickHouse SQL query to fetch data'), jsCode: z.string().optional().describe('JavaScript function to transform query results. Must be function that takes data parameter and returns component data structure. Example: function transform(data) { return { xAxis: {data: data.map(r => r.name)}, series: [{data: data.map(r => r.value)}] }; }'), alasqlTransform: z.string().optional().describe('Optional AlaSQL query for additional transformation after JS (rarely needed)')}).optional().describe('Optional: Fetch data from ClickHouse and transform with JS function'), style: z.any().optional().describe('Custom container styles')})"
      }
    },
    {
      "nodeId": "tool_update_component",
      "nodeType": "tool_custom_frontend",
      "label": "Update Component",
      "positionX": 500,
      "positionY": 800,
      "data": {
        "agentColor": "#EF4444",
        "isExpanded": false,
        "isConfigured": true,
        "label": "Update Component",
        "color": "#6366F1",
        "type": "frontend",
        "toolTitle": "update_component",
        "toolDescription": "Update component data or configuration. Operations: set (replace), push (array add), splice (remove), merge (deep merge). Use path for nested updates. Returns execution trace with query response and transformation results.",
        "customToolZodSchema": "z.object({id: z.string().describe('Component ID to update'), path: z.string().optional().describe('JSONPath for nested updates like data.series[0].data'), updates: z.any().optional().describe('New value or data to apply'), operation: z.enum(['set', 'push', 'splice', 'merge']).optional().default('set').describe('Operation: set=replace, push=add to array, splice=remove from array, merge=deep merge'), operationParams: z.any().optional().describe('Extra params for splice: {start, deleteCount, items}')})"
      }
    },
    {
      "nodeId": "tool_remove_component",
      "nodeType": "tool_custom_frontend",
      "label": "Remove Component",
      "positionX": 700,
      "positionY": 600,
      "data": {
        "agentColor": "#EF4444",
        "isExpanded": false,
        "isConfigured": true,
        "label": "Remove Component",
        "color": "#6366F1",
        "type": "frontend",
        "toolTitle": "remove_component",
        "toolDescription": "Remove a component from the dashboard by its ID. The component will be completely deleted from the dashboard state.",
        "customToolZodSchema": "z.object({id: z.string().describe('ID of the component to remove')})"
      }
    },
    {
      "nodeId": "tool_get_component",
      "nodeType": "tool_custom_frontend",
      "label": "Get Component",
      "positionX": 100,
      "positionY": 1000,
      "data": {
        "agentColor": "#EF4444",
        "isExpanded": false,
        "isConfigured": true,
        "label": "Get Component",
        "color": "#6366F1",
        "type": "frontend",
        "toolTitle": "get_component",
        "toolDescription": "Retrieve a specific component's full configuration by its ID. Returns the component's type, title, data, config, and grid area placement.",
        "customToolZodSchema": "z.object({id: z.string().describe('ID of the component to retrieve')})"
      }
    },
    {
      "nodeId": "main-agent",
      "nodeType": "agent",
      "label": "Chart Builder",
      "positionX": 300,
      "positionY": 200,
      "data": {
        "id": "cmhijn9sv0007qggw7c4ipwm3",
        "label": "Chart Builder",
        "subtitle": "AI Agent",
        "status": "offline",
        "description": "Dashboard Builder with JS Transform Functions",
        "icon": "tool",
        "color": "#EF4444",
        "toolsCount": 6,
        "componentsCount": 0,
        "mcpCount": 0,
        "knowledgeBaseCount": 0,
        "configNodesCount": 3,
        "toolNodesCount": 6
      }
    }
  ],
  "edges": [
    {
      "edgeId": "edge_model",
      "sourceId": "model_node",
      "targetId": "main-agent",
      "targetHandle": "config",
      "edgeType": "custom"
    },
    {
      "edgeId": "edge_system_prompt",
      "sourceId": "system_prompt_node",
      "targetId": "main-agent",
      "targetHandle": "config",
      "edgeType": "custom"
    },
    {
      "edgeId": "edge_prompt",
      "sourceId": "prompt_node",
      "targetId": "main-agent",
      "targetHandle": "config",
      "edgeType": "custom"
    },
    {
      "edgeId": "edge_tool_set_grid",
      "sourceId": "tool_set_grid_layout",
      "targetId": "main-agent",
      "targetHandle": "features",
      "edgeType": "custom"
    },
    {
      "edgeId": "edge_tool_get_dashboard",
      "sourceId": "tool_get_dashboard",
      "targetId": "main-agent",
      "targetHandle": "features",
      "edgeType": "custom"
    },
    {
      "edgeId": "edge_tool_get_component",
      "sourceId": "tool_get_component",
      "targetId": "main-agent",
      "targetHandle": "features",
      "edgeType": "custom"
    },
    {
      "edgeId": "edge_tool_remove",
      "sourceId": "tool_remove_component",
      "targetId": "main-agent",
      "targetHandle": "features",
      "edgeType": "custom"
    },
    {
      "edgeId": "edge_tool_create",
      "sourceId": "tool_create_component",
      "targetId": "main-agent",
      "targetHandle": "features",
      "edgeType": "custom"
    },
    {
      "edgeId": "edge_tool_update",
      "sourceId": "tool_update_component",
      "targetId": "main-agent",
      "targetHandle": "features",
      "edgeType": "custom"
    }
  ],
  "metadata": {
    "totalNodes": 9,
    "totalSystemNodes": 8,
    "totalEdges": 9,
    "nodeTypes": [
      "model",
      "system_prompt",
      "prompt",
      "tool_custom_frontend",
      "agent"
    ],
    "hasAgentNode": true
  },
  "nodeTypes": [
    "model",
    "system_prompt",
    "prompt",
    "tool_custom_frontend",
    "agent"
  ]
}

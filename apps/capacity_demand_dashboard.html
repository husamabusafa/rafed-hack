<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="theme.css">
    <title>Capacity & Demand Dashboard - Rafed Transport</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="shared.js"></script>
    <style>
        body { background: #0f172a; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; transition: all 0.2s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .kpi-value { font-size: 2rem; font-weight: 700; }
        .gradient-red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .gradient-orange { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .gradient-green { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .gradient-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .progress-bar { height: 8px; border-radius: 4px; background: #334155; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.8s ease; }
        #map { border-radius: 12px; }
        .map-legend { background: rgba(30, 41, 59, 0.95); border-radius: 8px; padding: 12px; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
</head>
<body class="min-h-screen text-gray-100 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="dashboard-header">
            <div>
                <h1 class="dashboard-title">
                    <iconify-icon icon="solar:full-battery-bold" width="24" height="24" style="color: var(--warning);"></iconify-icon>
                    Capacity & Demand Analysis
                </h1>
                <p class="dashboard-subtitle">Transport capacity vs student demand gap analysis</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="index.html" class="btn btn-secondary btn-sm">
                    <iconify-icon icon="solar:arrow-left-linear" width="16" height="16"></iconify-icon>
                    Back
                </a>
                <button onclick="refreshData()" id="refreshBtn" class="btn btn-primary btn-sm">
                    <iconify-icon icon="solar:refresh-bold" width="16" height="16" id="refreshIcon"></iconify-icon>
                    Refresh
                </button>
            </div>
        </header>

        <!-- KPI Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="kpi-card" style="--kpi-accent: var(--info); --kpi-bg: var(--info-light); --kpi-color: var(--info);">
                <div class="kpi-header">
                    <span class="kpi-label">Total Demand</span>
                    <div class="kpi-icon">
                        <iconify-icon icon="solar:users-group-rounded-bold" width="20" height="20"></iconify-icon>
                    </div>
                </div>
                <div id="kpi-demand" class="kpi-value">-</div>
                <p class="kpi-description">Students needing transport</p>
            </div>
            <div class="kpi-card" style="--kpi-accent: var(--success); --kpi-bg: var(--success-light); --kpi-color: var(--success);">
                <div class="kpi-header">
                    <span class="kpi-label">Total Capacity</span>
                    <div class="kpi-icon">
                        <iconify-icon icon="solar:bus-bold" width="20" height="20"></iconify-icon>
                    </div>
                </div>
                <div id="kpi-capacity" class="kpi-value success">-</div>
                <p class="kpi-description">Available bus seats</p>
            </div>
            <div class="kpi-card" style="--kpi-accent: var(--danger); --kpi-bg: var(--danger-light); --kpi-color: var(--danger);">
                <div class="kpi-header">
                    <span class="kpi-label">Capacity Gap</span>
                    <div class="kpi-icon">
                        <iconify-icon icon="solar:danger-triangle-bold" width="20" height="20"></iconify-icon>
                    </div>
                </div>
                <div id="kpi-gap" class="kpi-value danger">-</div>
                <p class="kpi-description">Unmet demand</p>
            </div>
            <div class="kpi-card" style="--kpi-accent: var(--warning); --kpi-bg: var(--warning-light); --kpi-color: var(--warning);">
                <div class="kpi-header">
                    <span class="kpi-label">Utilization Rate</span>
                    <div class="kpi-icon">
                        <iconify-icon icon="solar:chart-bold" width="20" height="20"></iconify-icon>
                    </div>
                </div>
                <div id="kpi-util" class="kpi-value warning">-</div>
                <p class="kpi-description">Of available capacity</p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Capacity Breakdown -->
            <div class="card p-5">
                <h3 class="text-lg font-semibold text-white mb-4">Capacity by Vehicle Type</h3>
                <div id="vehicle-breakdown" class="space-y-4">
                    <div class="pulse bg-slate-700 h-16 rounded-lg"></div>
                    <div class="pulse bg-slate-700 h-16 rounded-lg"></div>
                    <div class="pulse bg-slate-700 h-16 rounded-lg"></div>
                </div>
            </div>

            <!-- Unassigned Students -->
            <div class="card p-5">
                <h3 class="text-lg font-semibold text-white mb-4">Unassigned Students</h3>
                <div id="unassigned-chart-container" style="height: 220px;">
                    <canvas id="unassignedChart"></canvas>
                </div>
                <div id="unassigned-total" class="text-center mt-3 text-gray-400 text-sm"></div>
            </div>

            <!-- Utilization Distribution -->
            <div class="card p-5">
                <h3 class="text-lg font-semibold text-white mb-4">Route Utilization Distribution</h3>
                <div id="util-chart-container" style="height: 220px;">
                    <canvas id="utilChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="card p-5 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">Demand Hotspots Map</h3>
                <div class="flex items-center gap-4 text-sm">
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500"></span> High Demand</span>
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-yellow-500"></span> Medium</span>
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> Low</span>
                </div>
            </div>
            <div id="map" style="height: 400px;"></div>
        </div>

        <!-- Regional Gap Analysis -->
        <div class="card p-5">
            <h3 class="text-lg font-semibold text-white mb-4">Regional Capacity Gap Analysis</h3>
            <div id="regional-gaps" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="pulse bg-slate-700 h-24 rounded-lg"></div>
                <div class="pulse bg-slate-700 h-24 rounded-lg"></div>
                <div class="pulse bg-slate-700 h-24 rounded-lg"></div>
            </div>
        </div>
    </div>

    <script>
        let map, unassignedChart, utilChart;

        async function loadKPIs() {
            const sql = `SELECT 
                sum(student_count) as total_served,
                sum(capacity) as total_capacity,
                round(avg(utilization), 1) as avg_util
            FROM school_routes`;
            
            const data = await queryClickHouse(sql);
            if (data.length) {
                const row = data[0];
                const served = row.total_served || 0;
                const capacity = row.total_capacity || 0;
                const gap = capacity - served;
                
                animateValue('kpi-demand', 0, served, 1500, fmt.compact);
                animateValue('kpi-capacity', 0, capacity, 1500, fmt.compact);
                animateValue('kpi-gap', 0, gap, 1500, v => '+' + fmt.compact(v));
                animateValue('kpi-util', 0, row.avg_util || 0, 1500, v => v.toFixed(1) + '%');
            }
        }

        async function loadVehicleBreakdown() {
            const sql = `SELECT 
                vehicle_type,
                count(*) as routes,
                sum(student_count) as students,
                sum(capacity) as capacity,
                round(avg(utilization), 1) as util
            FROM school_routes 
            GROUP BY vehicle_type 
            ORDER BY capacity DESC`;
            
            const data = await queryClickHouse(sql);
            const container = document.getElementById('vehicle-breakdown');
            
            const icons = {
                'large': 'ðŸšŒ',
                'medium': 'ðŸš',
                'small': 'ðŸš™'
            };
            const colors = {
                'large': 'from-blue-500 to-blue-600',
                'medium': 'from-green-500 to-green-600', 
                'small': 'from-orange-500 to-orange-600'
            };
            
            container.innerHTML = data.map(row => `
                <div class="bg-slate-800 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${icons[row.vehicle_type] || 'ðŸš—'}</span>
                            <div>
                                <div class="font-semibold text-white capitalize">${row.vehicle_type} Buses</div>
                                <div class="text-xs text-gray-400">${fmt.number(row.routes)} routes</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-white">${fmt.compact(row.students)}</div>
                            <div class="text-xs text-gray-400">of ${fmt.compact(row.capacity)} capacity</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill bg-gradient-to-r ${colors[row.vehicle_type]}" style="width: ${row.util}%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 text-right">${row.util}% utilized</div>
                </div>
            `).join('');
        }

        async function loadUnassignedChart() {
            const sql = `SELECT reason, count(*) as cnt FROM unassigned_students GROUP BY reason ORDER BY cnt DESC`;
            const data = await queryClickHouse(sql);
            
            const labels = {
                'capacity_or_constraint': 'Capacity Constraints',
                'vroom_http_500': 'Routing Errors',
                'bad_coordinates_vroom': 'Invalid Location'
            };
            
            const ctx = document.getElementById('unassignedChart').getContext('2d');
            if (unassignedChart) unassignedChart.destroy();
            
            unassignedChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(r => labels[r.reason] || r.reason),
                    datasets: [{
                        data: data.map(r => r.cnt),
                        backgroundColor: ['#ef4444', '#f97316', '#eab308'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#9ca3af', padding: 15, usePointStyle: true }
                        }
                    },
                    cutout: '65%'
                }
            });
            
            const total = data.reduce((a, b) => a + b.cnt, 0);
            document.getElementById('unassigned-total').innerHTML = `<span class="text-red-400 font-bold">${fmt.compact(total)}</span> students unassigned`;
        }

        async function loadUtilChart() {
            const sql = `SELECT 
                CASE 
                    WHEN utilization >= 90 THEN 'Overloaded (90%+)'
                    WHEN utilization >= 70 THEN 'Optimal (70-90%)'
                    WHEN utilization >= 50 THEN 'Moderate (50-70%)'
                    ELSE 'Underutilized (<50%)'
                END as category,
                count(*) as routes
            FROM school_routes 
            GROUP BY category 
            ORDER BY routes DESC`;
            
            const data = await queryClickHouse(sql);
            const ctx = document.getElementById('utilChart').getContext('2d');
            if (utilChart) utilChart.destroy();
            
            const colorMap = {
                'Overloaded (90%+)': '#ef4444',
                'Optimal (70-90%)': '#22c55e',
                'Moderate (50-70%)': '#f97316',
                'Underutilized (<50%)': '#eab308'
            };
            
            utilChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(r => r.category),
                    datasets: [{
                        data: data.map(r => r.routes),
                        backgroundColor: data.map(r => colorMap[r.category] || '#6366f1'),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#9ca3af', callback: v => fmt.compact(v) }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        async function loadMap() {
            map = new maplibregl.Map({
                container: 'map',
                style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                center: [45.0, 24.5],
                zoom: 5
            });

            map.on('load', async () => {
                const sql = `SELECT region_name, lat, lon, total_students, bus_eligible, 
                    bus_eligible - (SELECT sum(student_count) FROM school_routes) / 13.0 as demand_gap
                FROM vw_transport_demand_hotspots 
                WHERE lat IS NOT NULL AND lon IS NOT NULL`;
                
                const data = await queryClickHouse(sql);
                
                const features = data.map(row => ({
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [row.lon, row.lat] },
                    properties: {
                        region: row.region_name,
                        students: row.total_students,
                        eligible: row.bus_eligible,
                        size: Math.sqrt(row.bus_eligible) / 10
                    }
                }));

                map.addSource('hotspots', {
                    type: 'geojson',
                    data: { type: 'FeatureCollection', features }
                });

                map.addLayer({
                    id: 'hotspots-heat',
                    type: 'circle',
                    source: 'hotspots',
                    paint: {
                        'circle-radius': ['get', 'size'],
                        'circle-color': [
                            'interpolate', ['linear'], ['get', 'eligible'],
                            0, '#22c55e',
                            200000, '#eab308',
                            500000, '#ef4444'
                        ],
                        'circle-opacity': 0.7,
                        'circle-stroke-width': 1,
                        'circle-stroke-color': '#fff'
                    }
                });

                const popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });
                
                map.on('mouseenter', 'hotspots-heat', (e) => {
                    map.getCanvas().style.cursor = 'pointer';
                    const props = e.features[0].properties;
                    popup.setLngLat(e.lngLat)
                        .setHTML(`
                            <div style="background:#1e293b;color:#fff;padding:8px 12px;border-radius:8px;font-size:12px;">
                                <div style="font-weight:600;margin-bottom:4px;">${props.region}</div>
                                <div>Total Students: ${fmt.number(props.students)}</div>
                                <div>Bus Eligible: ${fmt.number(props.eligible)}</div>
                            </div>
                        `)
                        .addTo(map);
                });
                
                map.on('mouseleave', 'hotspots-heat', () => {
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                });
            });
        }

        async function loadRegionalGaps() {
            const sql = `SELECT 
                region_name,
                sum(total_demand) as demand,
                sum(total_capacity) as capacity,
                sum(capacity_gap) as gap,
                count(*) as zones
            FROM vw_demand_capacity_gap 
            WHERE total_demand > 0
            GROUP BY region_name 
            ORDER BY gap DESC 
            LIMIT 6`;
            
            const data = await queryClickHouse(sql);
            const container = document.getElementById('regional-gaps');
            
            container.innerHTML = data.map(row => {
                const fillPct = row.capacity > 0 ? Math.min(100, (row.demand / row.capacity) * 100) : 0;
                const isOvercap = row.demand > row.capacity;
                
                return `
                    <div class="bg-slate-800 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="font-semibold text-white text-sm">${row.region_name}</div>
                                <div class="text-xs text-gray-500">${row.zones} zones</div>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-medium ${isOvercap ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">
                                ${isOvercap ? 'Over capacity' : 'Available'}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs mb-2">
                            <div><span class="text-gray-400">Demand:</span> <span class="text-white">${fmt.compact(row.demand)}</span></div>
                            <div><span class="text-gray-400">Capacity:</span> <span class="text-white">${fmt.compact(row.capacity)}</span></div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${isOvercap ? 'bg-red-500' : 'bg-green-500'}" style="width: ${Math.min(fillPct, 100)}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            const icon = document.getElementById('refreshIcon');
            btn.disabled = true;
            icon.classList.add('animate-spin');
            
            await Promise.all([
                loadKPIs(),
                loadVehicleBreakdown(),
                loadUnassignedChart(),
                loadUtilChart(),
                loadRegionalGaps()
            ]);
            
            btn.disabled = false;
            icon.classList.remove('animate-spin');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadKPIs();
            loadVehicleBreakdown();
            loadUnassignedChart();
            loadUtilChart();
            loadMap();
            loadRegionalGaps();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rafed - Student Density Heatmap</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconify -->
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    
    <!-- Deck.gl -->
    <script src="https://unpkg.com/deck.gl@8.9.30/dist.min.js"></script>
    
    <!-- MapLibre GL -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Shared Utilities -->
    <script src="shared.js"></script>

    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #0f172a; 
            color: #e2e8f0;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            padding: 1rem 1.5rem;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 0;
            min-height: 0;
        }
        
        .map-section {
            position: relative;
        }
        
        #deck-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            background: #1e293b;
            border-left: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid #334155;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .layer-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .toggle-btn {
            flex: 1;
            padding: 0.5rem;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            color: #94a3b8;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toggle-btn.active {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-color: #f97316;
            color: white;
        }
        
        .toggle-btn:hover:not(.active) {
            border-color: #475569;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #334155;
        }
        
        .metric-label { color: #94a3b8; font-size: 0.75rem; }
        .metric-value { color: #f1f5f9; font-weight: 600; font-size: 0.875rem; }
        
        .color-bar {
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%);
            margin: 0.5rem 0;
        }
        
        .color-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.625rem;
            color: #64748b;
        }
        
        .controls-panel {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 1rem;
            width: 260px;
            z-index: 100;
        }
        
        .slider-group {
            margin-bottom: 1rem;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #334155;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #f97316;
            cursor: pointer;
        }
        
        .stat-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
        }
        
        .stat-card-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #f1f5f9;
        }
        
        .stat-card-label {
            font-size: 0.625rem;
            color: #64748b;
            text-transform: uppercase;
        }
        
        .chart-container {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .chart-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 0.75rem;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .region-filter {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: #e2e8f0;
            font-size: 0.75rem;
            width: 100%;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-orange-600 rounded-lg flex items-center justify-center shadow-lg shadow-orange-600/20">
                <iconify-icon icon="solar:fire-bold" class="text-xl text-white"></iconify-icon>
            </div>
            <div>
                <h1 class="text-lg font-bold text-white">Student Density Heatmap</h1>
                <p class="text-xs text-slate-400">3D Hexagon Visualization of Student Distribution</p>
            </div>
        </div>
        <div class="flex gap-3">
            <a href="deckgl_3d_analytics.html" class="px-3 py-1.5 bg-slate-700 rounded text-xs text-slate-200 hover:bg-slate-600 transition-colors flex items-center gap-2">
                <iconify-icon icon="solar:map-bold" width="14"></iconify-icon>
                Regional 3D View
            </a>
            <a href="index.html" class="px-3 py-1.5 bg-slate-700 rounded text-xs text-slate-200 hover:bg-slate-600 transition-colors flex items-center gap-2">
                <iconify-icon icon="solar:arrow-left-linear" width="14"></iconify-icon>
                Back to Hub
            </a>
        </div>
    </header>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Map Section -->
        <div class="map-section">
            <div id="deck-canvas"></div>
            
            <!-- Controls Panel -->
            <div class="controls-panel">
                <div class="section-title">Layer Type</div>
                <div class="layer-toggle">
                    <button class="toggle-btn active" data-layer="hexagon" onclick="setLayerType('hexagon')">
                        <iconify-icon icon="solar:tuning-square-2-bold" width="14"></iconify-icon>
                        Hexagon
                    </button>
                    <button class="toggle-btn" data-layer="heatmap" onclick="setLayerType('heatmap')">
                        <iconify-icon icon="solar:fire-bold" width="14"></iconify-icon>
                        Heatmap
                    </button>
                    <button class="toggle-btn" data-layer="scatter" onclick="setLayerType('scatter')">
                        <iconify-icon icon="solar:point-on-map-bold" width="14"></iconify-icon>
                        Points
                    </button>
                </div>
                
                <div class="section-title">Visualization Settings</div>
                
                <div class="slider-group">
                    <div class="slider-header">
                        <span>Radius</span>
                        <span id="radius-value">500m</span>
                    </div>
                    <input type="range" class="slider" id="radius-slider" min="100" max="2000" step="100" value="500" onchange="updateRadius(this.value)">
                </div>
                
                <div class="slider-group">
                    <div class="slider-header">
                        <span>Elevation Scale</span>
                        <span id="elevation-value">100</span>
                    </div>
                    <input type="range" class="slider" id="elevation-slider" min="10" max="500" step="10" value="100" onchange="updateElevation(this.value)">
                </div>
                
                <div class="slider-group">
                    <div class="slider-header">
                        <span>Coverage</span>
                        <span id="coverage-value">90%</span>
                    </div>
                    <input type="range" class="slider" id="coverage-slider" min="0.5" max="1" step="0.05" value="0.9" onchange="updateCoverage(this.value)">
                </div>
            </div>
            
            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loading">
                <div class="text-center">
                    <iconify-icon icon="solar:spinner-bold" width="48" class="text-orange-500 animate-spin"></iconify-icon>
                    <p class="text-slate-400 mt-4">Loading student data...</p>
                    <p class="text-slate-500 text-sm mt-2" id="loading-status">Initializing...</p>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="section-title">Data Source</div>
                <select class="region-filter" id="data-source" onchange="updateDataSource(this.value)">
                    <option value="all">All Students</option>
                    <option value="buseligible">Bus Eligible Only</option>
                    <option value="unassigned">Unassigned Students</option>
                </select>
                
                <div class="stat-cards">
                    <div class="stat-card">
                        <div class="stat-card-value" id="total-points">-</div>
                        <div class="stat-card-label">Data Points</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="max-density">-</div>
                        <div class="stat-card-label">Max Density</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="avg-density">-</div>
                        <div class="stat-card-label">Avg per Hex</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="total-hexagons">-</div>
                        <div class="stat-card-label">Hexagons</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="section-title">Color Legend</div>
                <div class="color-bar"></div>
                <div class="color-labels">
                    <span>Low Density</span>
                    <span>High Density</span>
                </div>
                
                <div class="section-title" style="margin-top: 1.5rem;">Top Density Areas</div>
                <div id="top-areas">
                    <!-- Populated by JS -->
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">Density Distribution</div>
                    <canvas id="density-chart" height="150"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">Student Type Breakdown</div>
                    <canvas id="type-chart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let deckInstance = null;
        let studentData = [];
        let currentLayerType = 'hexagon';
        let hexRadius = 500;
        let elevationScale = 100;
        let coverage = 0.9;
        let dataSource = 'all';
        let densityChart = null;
        let typeChart = null;
        
        // Color range for hexagons
        const COLOR_RANGE = [
            [65, 182, 196],
            [127, 205, 187],
            [199, 233, 180],
            [237, 248, 177],
            [255, 255, 204],
            [255, 237, 160],
            [254, 217, 118],
            [254, 178, 76],
            [253, 141, 60],
            [252, 78, 42],
            [227, 26, 28],
            [189, 0, 38]
        ];
        
        // Initialize
        async function init() {
            try {
                updateLoadingStatus('Fetching student locations...');
                
                // Load student data from ClickHouse
                // Try students table first, then fall back to unassigned_students
                let data = await queryClickHouse(`
                    SELECT 
                        toFloat64(lat) as lat, 
                        toFloat64(lon) as lon,
                        bus_elig,
                        1 as student_type
                    FROM students 
                    WHERE lat IS NOT NULL AND lon IS NOT NULL
                    LIMIT 500000
                `);
                
                if (!data || data.length === 0) {
                    updateLoadingStatus('Trying alternative data source...');
                    data = await queryClickHouse(`
                        SELECT 
                            toFloat64(lat) as lat, 
                            toFloat64(lon) as lon,
                            1 as bus_elig,
                            2 as student_type
                        FROM unassigned_students 
                        WHERE lat IS NOT NULL AND lon IS NOT NULL
                        LIMIT 100000
                    `);
                }
                
                if (!data || data.length === 0) {
                    throw new Error('No student location data available');
                }
                
                studentData = data;
                console.log(`Loaded ${studentData.length} student locations`);
                
                updateLoadingStatus('Initializing visualization...');
                
                // Initialize deck.gl
                initDeckGL();
                
                // Update stats
                updateStats();
                
                // Create charts
                createCharts();
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-center">
                        <iconify-icon icon="solar:danger-triangle-bold" width="48" class="text-red-500"></iconify-icon>
                        <p class="text-red-400 mt-4">Failed to load data</p>
                        <p class="text-slate-500 text-sm mt-2">${error.message}</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-orange-600 text-white rounded text-sm">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function updateLoadingStatus(status) {
            document.getElementById('loading-status').textContent = status;
        }
        
        // Filter data based on source selection
        function getFilteredData() {
            switch (dataSource) {
                case 'buseligible':
                    return studentData.filter(d => d.bus_elig == 1);
                case 'unassigned':
                    return studentData.filter(d => d.student_type == 2);
                default:
                    return studentData;
            }
        }
        
        // Initialize Deck.gl
        function initDeckGL() {
            const { DeckGL } = deck;
            
            // Calculate initial center from data
            const data = getFilteredData();
            let centerLon = 46.7, centerLat = 24.7;
            
            if (data.length > 0) {
                centerLon = data.reduce((sum, d) => sum + d.lon, 0) / data.length;
                centerLat = data.reduce((sum, d) => sum + d.lat, 0) / data.length;
            }
            
            deckInstance = new DeckGL({
                container: 'deck-canvas',
                mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                initialViewState: {
                    longitude: centerLon,
                    latitude: centerLat,
                    zoom: 10,
                    pitch: 50,
                    bearing: -20
                },
                controller: true,
                layers: [createLayer()],
                getTooltip: getTooltip
            });
        }
        
        // Create appropriate layer based on type
        function createLayer() {
            const { HexagonLayer, HeatmapLayer, ScatterplotLayer } = deck;
            const data = getFilteredData();
            
            switch (currentLayerType) {
                case 'hexagon':
                    return new HexagonLayer({
                        id: 'hexagon-layer',
                        data: data,
                        getPosition: d => [d.lon, d.lat],
                        radius: hexRadius,
                        elevationScale: elevationScale,
                        elevationRange: [0, 3000],
                        extruded: true,
                        coverage: coverage,
                        colorRange: COLOR_RANGE,
                        pickable: true,
                        onSetColorDomain: domain => console.log('Color domain:', domain)
                    });
                    
                case 'heatmap':
                    return new HeatmapLayer({
                        id: 'heatmap-layer',
                        data: data,
                        getPosition: d => [d.lon, d.lat],
                        getWeight: d => 1,
                        radiusPixels: 30,
                        intensity: 1,
                        threshold: 0.03,
                        colorRange: COLOR_RANGE
                    });
                    
                case 'scatter':
                    return new ScatterplotLayer({
                        id: 'scatter-layer',
                        data: data,
                        getPosition: d => [d.lon, d.lat],
                        getFillColor: d => d.bus_elig == 1 ? [249, 115, 22, 180] : [100, 116, 139, 150],
                        getRadius: 30,
                        radiusMinPixels: 2,
                        radiusMaxPixels: 10,
                        pickable: true
                    });
                    
                default:
                    return null;
            }
        }
        
        // Tooltip handler
        function getTooltip({object}) {
            if (!object) return null;
            
            if (currentLayerType === 'hexagon') {
                const count = object.points ? object.points.length : object.colorValue || 0;
                return {
                    html: `
                        <div style="font-weight: 600; margin-bottom: 4px;">Hexagon Area</div>
                        <div>Students: <strong>${count}</strong></div>
                    `,
                    style: {
                        backgroundColor: '#1e293b',
                        border: '1px solid #475569',
                        borderRadius: '8px',
                        padding: '8px 12px',
                        fontSize: '12px',
                        color: '#f1f5f9'
                    }
                };
            } else if (currentLayerType === 'scatter') {
                return {
                    html: `
                        <div style="font-weight: 600; margin-bottom: 4px;">Student Location</div>
                        <div>Bus Eligible: ${object.bus_elig == 1 ? 'Yes' : 'No'}</div>
                    `,
                    style: {
                        backgroundColor: '#1e293b',
                        border: '1px solid #475569',
                        borderRadius: '8px',
                        padding: '8px 12px',
                        fontSize: '12px',
                        color: '#f1f5f9'
                    }
                };
            }
            
            return null;
        }
        
        // Update layer
        function updateLayer() {
            if (!deckInstance) return;
            
            deckInstance.setProps({
                layers: [createLayer()]
            });
            
            updateStats();
        }
        
        // Update statistics
        function updateStats() {
            const data = getFilteredData();
            const total = data.length;
            
            // Estimate hexagon stats (rough calculation)
            const hexCount = Math.ceil(total / 10); // Rough estimate
            const avgDensity = Math.round(total / Math.max(hexCount, 1));
            const maxDensity = Math.round(avgDensity * 3); // Estimate
            
            document.getElementById('total-points').textContent = fmt.compact(total);
            document.getElementById('max-density').textContent = fmt.compact(maxDensity);
            document.getElementById('avg-density').textContent = fmt.compact(avgDensity);
            document.getElementById('total-hexagons').textContent = fmt.compact(hexCount);
            
            // Update top areas list
            updateTopAreas();
        }
        
        // Update top areas display
        function updateTopAreas() {
            const data = getFilteredData();
            
            // Group by approximate grid
            const gridSize = 0.01; // ~1km
            const grid = {};
            
            data.forEach(d => {
                const key = `${Math.floor(d.lat / gridSize)}_${Math.floor(d.lon / gridSize)}`;
                grid[key] = (grid[key] || 0) + 1;
            });
            
            // Sort and get top 5
            const sorted = Object.entries(grid)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const html = sorted.map((item, i) => {
                const [key, count] = item;
                return `
                    <div class="metric-row">
                        <span class="metric-label">Area ${i + 1}</span>
                        <span class="metric-value">${fmt.number(count)} students</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('top-areas').innerHTML = html || '<p class="text-slate-500 text-sm">No data</p>';
        }
        
        // Create charts
        function createCharts() {
            // Density distribution chart
            const densityCtx = document.getElementById('density-chart').getContext('2d');
            densityChart = new Chart(densityCtx, {
                type: 'bar',
                data: {
                    labels: ['0-10', '11-50', '51-100', '101-200', '200+'],
                    datasets: [{
                        label: 'Hexagons',
                        data: [45, 30, 15, 7, 3], // Placeholder data
                        backgroundColor: [
                            'rgba(65, 182, 196, 0.8)',
                            'rgba(127, 205, 187, 0.8)',
                            'rgba(254, 217, 118, 0.8)',
                            'rgba(253, 141, 60, 0.8)',
                            'rgba(227, 26, 28, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#64748b', font: { size: 10 } }
                        },
                        y: {
                            grid: { color: '#334155' },
                            ticks: { color: '#64748b', font: { size: 10 } }
                        }
                    }
                }
            });
            
            // Student type breakdown
            const typeCtx = document.getElementById('type-chart').getContext('2d');
            const busEligible = studentData.filter(d => d.bus_elig == 1).length;
            const notEligible = studentData.length - busEligible;
            
            typeChart = new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Bus Eligible', 'Not Eligible'],
                    datasets: [{
                        data: [busEligible, notEligible],
                        backgroundColor: ['#f97316', '#64748b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', font: { size: 10 }, padding: 8 }
                        }
                    }
                }
            });
        }
        
        // Set layer type
        function setLayerType(type) {
            currentLayerType = type;
            
            // Update button states
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.layer === type);
            });
            
            updateLayer();
        }
        
        // Update radius
        function updateRadius(value) {
            hexRadius = parseInt(value);
            document.getElementById('radius-value').textContent = hexRadius + 'm';
            updateLayer();
        }
        
        // Update elevation
        function updateElevation(value) {
            elevationScale = parseInt(value);
            document.getElementById('elevation-value').textContent = elevationScale;
            updateLayer();
        }
        
        // Update coverage
        function updateCoverage(value) {
            coverage = parseFloat(value);
            document.getElementById('coverage-value').textContent = Math.round(coverage * 100) + '%';
            updateLayer();
        }
        
        // Update data source
        function updateDataSource(value) {
            dataSource = value;
            updateLayer();
            
            // Update type chart
            if (typeChart) {
                const data = getFilteredData();
                const busEligible = data.filter(d => d.bus_elig == 1).length;
                const notEligible = data.length - busEligible;
                typeChart.data.datasets[0].data = [busEligible, notEligible];
                typeChart.update();
            }
        }
        
        // Initialize
        init();
    </script>
</body>
</html>

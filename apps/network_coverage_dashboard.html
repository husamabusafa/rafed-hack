<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="theme.css">
    <title>Rafed - Network Coverage & Accessibility</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://unpkg.com/deck.gl@8.9.30/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        .metric-card { @apply p-5 flex flex-col justify-between card h-32; }
        .btn-blue { @apply px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors; }
        #map-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; }
    </style>
</head>
<body class="p-6 h-screen flex flex-col">

    <!-- Header -->
    <header class="dashboard-header">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-600/20">
                <iconify-icon icon="solar:radar-2-bold" class="text-xl text-white"></iconify-icon>
            </div>
            <div>
                <h1 class="dashboard-title">Network Coverage</h1>
                <p class="dashboard-subtitle">Distances, Isochrones, and Accessibility</p>
            </div>
        </div>
        <div class="flex gap-3 items-center">
            <a href="index.html" class="btn btn-secondary btn-sm">
                <iconify-icon icon="solar:arrow-left-linear" width="16" height="16"></iconify-icon>
                Back
            </a>
            <button onclick="location.reload()" class="btn btn-primary btn-sm">
                <iconify-icon icon="solar:refresh-bold" width="16" height="16"></iconify-icon>
                Refresh
            </button>
        </div>
    </header>

    <!-- Metrics -->
    <div class="grid grid-cols-5 gap-4 mb-6 flex-none">
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Avg Distance</h3>
            <div class="text-2xl font-bold text-white" id="avg-dist">- km</div>
            <div class="text-xs text-blue-400 flex gap-1 items-center">
                <iconify-icon icon="solar:ruler-angular-bold"></iconify-icon> Home to School
            </div>
        </div>
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Within 5km</h3>
            <div class="text-2xl font-bold text-white" id="coverage-5km">-%</div>
            <div class="text-xs text-emerald-400">Good coverage</div>
        </div>
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Long Commute (&gt;20km)</h3>
            <div class="text-2xl font-bold text-white" id="long-commute">-</div>
            <div class="text-xs text-orange-400">Need attention</div>
        </div>
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Safe Walk Eligible</h3>
            <div class="text-2xl font-bold text-white" id="walkable">-</div>
            <div class="text-xs text-green-400">Grade 7+, &lt;500m, Male</div>
        </div>
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Young &amp; Close</h3>
            <div class="text-2xl font-bold text-white" id="young-close">-</div>
            <div class="text-xs text-violet-400">KG-G3, &lt;500m (need escort)</div>
        </div>
    </div>

    <!-- Main -->
    <div class="grid grid-cols-3 gap-6 flex-1 min-h-0">
        
        <!-- Map -->
        <div class="col-span-2 card p-1 flex flex-col h-full">
            <div class="p-3 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                <h3 class="font-semibold text-white text-sm flex items-center gap-2">
                    <iconify-icon icon="solar:map-bold" class="text-blue-500"></iconify-icon>
                    Accessibility & Distances
                </h3>
                <div class="flex gap-3 text-xs">
                    <span class="flex items-center gap-1 text-slate-300"><span class="w-2 h-2 bg-green-500 rounded-full"></span> &lt; 3km</span>
                    <span class="flex items-center gap-1 text-slate-300"><span class="w-2 h-2 bg-orange-500 rounded-full"></span> &gt; 10km</span>
                </div>
            </div>
            <div class="flex-1 relative rounded-b-lg overflow-hidden">
                <div id="map-container"></div>
            </div>
        </div>

        <!-- Charts -->
        <div class="flex flex-col gap-4 h-full">
            
            <!-- Histogram -->
            <div class="card p-4 flex-1">
                <h3 class="font-semibold text-white text-sm mb-3">Distance Distribution</h3>
                <div class="h-[140px] w-full relative">
                    <canvas id="histChart"></canvas>
                </div>
            </div>

            <!-- Walkability by Grade -->
            <div class="card p-4 flex-1">
                <h3 class="font-semibold text-white text-sm mb-3">Walkability by Grade Level</h3>
                <div class="h-[140px] w-full relative">
                    <canvas id="walkChart"></canvas>
                </div>
            </div>

            <!-- Regional Distances -->
            <div class="card p-4 flex-1">
                <h3 class="font-semibold text-white text-sm mb-3">Avg Distance by Region</h3>
                <div class="h-[140px] w-full relative">
                    <canvas id="regionChart"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        const CH_API = 'http://localhost:8155';
        const AUTH = 'user=viewer&password=rafed_view&max_result_rows=0';

        async function query(sql) {
            try {
                const r = await fetch(`${CH_API}/?${AUTH}&query=${encodeURIComponent(sql + ' FORMAT JSON')}`);
                return await r.json();
            } catch(e) { console.error(e); return null; }
        }

        const format = (n) => Number(n).toLocaleString();

        async function init() {
            // 1. Metrics - with realistic walkability criteria
            // Safe to walk: Grade 7+ (age 13+), Male, distance < 500m
            // Young & close: KG to Grade 3, < 500m (need parent/guardian escort)
            const m = await query(`
                SELECT 
                    avg(dist_m)/1000 as avg_km,
                    countIf(dist_m < 5000) / count() * 100 as cov_5km,
                    countIf(dist_m > 20000) as long_commute,
                    countIf(
                        dist_m < 500 
                        AND grade IN ('Grade 7','Grade 8','Grade 9','Grade 10','Grade 11','Grade 12')
                        AND gender = 'Male'
                    ) as safe_walk,
                    countIf(
                        dist_m < 500 
                        AND grade IN ('KG','Grade 1','Grade 2','Grade 3')
                    ) as young_close
                FROM students
            `);
            
            if(m && m.data[0]) {
                const d = m.data[0];
                document.getElementById('avg-dist').innerText = d.avg_km.toFixed(1) + ' km';
                document.getElementById('coverage-5km').innerText = d.cov_5km.toFixed(1) + '%';
                document.getElementById('long-commute').innerText = format(d.long_commute);
                document.getElementById('walkable').innerText = format(d.safe_walk);
                document.getElementById('young-close').innerText = format(d.young_close);
            }

            // 2. Map (Students colored by distance) - Sample for performance (7.5M total)
            const points = await query(`
                SELECT toFloat64(lat) as lat, toFloat64(lon) as lon, dist_m 
                FROM students 
                WHERE lat IS NOT NULL AND lon IS NOT NULL
                ORDER BY cityHash64(id)
                LIMIT 100000
            `);

            if(points) {
                const { DeckGL, ScatterplotLayer } = deck;
                new DeckGL({
                    container: 'map-container',
                    mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                    initialViewState: { longitude: 46.7, latitude: 24.7, zoom: 10 },
                    controller: true,
                    layers: [
                        new ScatterplotLayer({
                            id: 'dist-points',
                            data: points.data,
                            getPosition: d => [d.lon, d.lat],
                            getFillColor: d => {
                                if (d.dist_m > 10000) return [249, 115, 22]; // Orange > 10km
                                if (d.dist_m < 3000) return [34, 197, 94];   // Green < 3km
                                return [59, 130, 246]; // Blue
                            },
                            getRadius: 50,
                            opacity: 0.7
                        })
                    ]
                });
            }

            // 3. Charts
            // Histogram
            const hist = await query(`
                SELECT 
                    countIf(dist_m BETWEEN 0 AND 2000) as b1,
                    countIf(dist_m BETWEEN 2000 AND 5000) as b2,
                    countIf(dist_m BETWEEN 5000 AND 10000) as b3,
                    countIf(dist_m > 10000) as b4
                FROM students
            `);
            
            if(hist) {
                const d = hist.data[0];
                new Chart(document.getElementById('histChart'), {
                    type: 'bar',
                    data: {
                        labels: ['< 2km', '2-5 km', '5-10 km', '> 10km'],
                        datasets: [{
                            label: 'Students',
                            data: [d.b1, d.b2, d.b3, d.b4],
                            backgroundColor: ['#22c55e', '#3b82f6', '#eab308', '#f97316'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { 
                            y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }, 
                            x: { ticks: { color: '#94a3b8' }, grid: { display: false } } 
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // Walkability by Grade Level
            const walkGrade = await query(`
                SELECT 
                    CASE 
                        WHEN grade IN ('KG', 'Grade 1', 'Grade 2', 'Grade 3') THEN 'KG-G3 (5-9y)'
                        WHEN grade IN ('Grade 4', 'Grade 5', 'Grade 6') THEN 'G4-G6 (10-12y)'
                        ELSE 'G7-G12 (13-18y)'
                    END as age_group,
                    countIf(dist_m < 500) as close,
                    countIf(dist_m < 500 AND gender = 'Male') as close_male,
                    count() as total
                FROM students
                GROUP BY age_group
                ORDER BY age_group
            `);
            
            if(walkGrade) {
                new Chart(document.getElementById('walkChart'), {
                    type: 'bar',
                    data: {
                        labels: walkGrade.data.map(d => d.age_group),
                        datasets: [
                            {
                                label: 'Close (<500m) - All',
                                data: walkGrade.data.map(d => d.close),
                                backgroundColor: '#94a3b8',
                                borderRadius: 4
                            },
                            {
                                label: 'Close (<500m) - Male',
                                data: walkGrade.data.map(d => d.close_male),
                                backgroundColor: '#22c55e',
                                borderRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { 
                            y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }, 
                            x: { ticks: { color: '#94a3b8' }, grid: { display: false } } 
                        },
                        plugins: { 
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: { color: '#94a3b8', boxWidth: 12, font: { size: 10 } }
                            } 
                        }
                    }
                });
            }

            // Region Chart
            const reg = await query(`
                SELECT region_ar, avg(dist_m)/1000 as km 
                FROM students 
                GROUP BY region_ar 
                ORDER BY km DESC 
                LIMIT 5
            `);
            
            if(reg) {
                new Chart(document.getElementById('regionChart'), {
                    type: 'bar',
                    data: {
                        labels: reg.data.map(d => d.region_ar),
                        datasets: [{
                            label: 'Avg Distance (km)',
                            data: reg.data.map(d => d.km),
                            backgroundColor: '#6366f1',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: { y: { ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
        init();
    </script>
</body>
</html>

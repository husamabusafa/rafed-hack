<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="theme.css">
    <title>Rafed - Customer Experience</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://unpkg.com/deck.gl@8.9.30/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="shared.js"></script>
    <script>
        if (!window.mapboxgl) window.mapboxgl = window.maplibregl;
    </script>

    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .card { 
            background-color: #1e293b; 
            border: 1px solid #334155; 
            border-radius: 0.75rem;
            transition: border-color 0.2s ease;
        }
        .card:hover { border-color: #475569; }
        .metric-card { 
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 8rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .btn-cyan { 
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #0891b2, #0e7490);
            color: white;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-cyan:hover { background: linear-gradient(135deg, #0e7490, #155e75); }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background: #334155; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="p-6 h-screen flex flex-col">

    <!-- Header -->
    <header class="dashboard-header">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-cyan-600 rounded-lg flex items-center justify-center shadow-lg shadow-cyan-600/20">
                <iconify-icon icon="solar:star-bold" class="text-xl text-white"></iconify-icon>
            </div>
            <div>
                <h1 class="dashboard-title">Customer Experience (CX)</h1>
                <p class="dashboard-subtitle">Complaint Monitoring & Satisfaction</p>
            </div>
        </div>
        <div class="flex gap-3 items-center">
            <span id="data-badge" class="hidden px-3 py-1 text-xs font-medium rounded-full bg-amber-500/15 text-amber-200 border border-amber-400/30">
                Demo data (ClickHouse offline)
            </span>
            <a href="index.html" class="btn btn-secondary btn-sm">
                <iconify-icon icon="solar:arrow-left-linear" width="16" height="16"></iconify-icon>
                Back
            </a>
            <button onclick="location.reload()" class="btn btn-primary btn-sm">
                <iconify-icon icon="solar:refresh-bold" width="16" height="16"></iconify-icon>
                Refresh
            </button>
        </div>
    </header>

    <!-- Metrics -->
    <div class="grid grid-cols-4 gap-6 mb-6 flex-none">
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Total Complaints</h3>
            <div class="text-3xl font-bold text-white" id="total-complaints">-</div>
            <div class="text-xs text-red-400 flex gap-1 items-center">
                <iconify-icon icon="solar:graph-up-bold"></iconify-icon> +12% this month
            </div>
        </div>
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Top Issue</h3>
            <div class="text-2xl font-bold text-white" id="top-issue">-</div>
            <div class="text-xs text-slate-500">Most frequent category</div>
        </div>
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Resolution Rate</h3>
            <div class="text-3xl font-bold text-white" id="resolution-rate">92%</div>
            <div class="text-xs text-emerald-400">Within SLA (48h)</div>
        </div>
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Satisfaction Score</h3>
            <div class="text-3xl font-bold text-white">4.2/5</div>
            <div class="text-xs text-slate-500">Based on R11 Survey</div>
        </div>
    </div>

    <!-- Main -->
    <div class="grid grid-cols-3 gap-6 flex-1 min-h-0">
        
        <!-- Map -->
        <div class="col-span-2 card p-1 flex flex-col h-full">
            <div class="p-3 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                <h3 class="font-semibold text-white text-sm flex items-center gap-2">
                    <iconify-icon icon="solar:map-point-bold" class="text-cyan-500"></iconify-icon>
                    Complaint Hotspots (Regional)
                </h3>
            </div>
            <div class="flex-1 relative rounded-b-lg overflow-hidden" style="min-height: 420px;">
                <div id="map-container" style="position:absolute; inset:0; width:100%; height:100%;"></div>
            </div>
        </div>

        <!-- Charts -->
        <div class="flex flex-col gap-6 h-full">
            
            <!-- Category Breakdown -->
            <div class="card p-4 flex-1">
                <h3 class="font-semibold text-white text-sm mb-4">Complaints by Category</h3>
                <div class="h-[200px] w-full relative">
                    <canvas id="catChart"></canvas>
                </div>
            </div>

            <!-- Trend -->
            <div class="card p-4 flex-1">
                <h3 class="font-semibold text-white text-sm mb-4">Complaints by Region</h3>
                <div class="h-[200px] w-full relative">
                    <canvas id="regionChart"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Use shared utilities
        async function query(sql) {
            const result = await queryClickHouseFull(sql);
            return result && result.success ? result.data : [];
        }

        const format = (n) => fmt.number(n);

        // Sample fallback data so dashboard renders when ClickHouse is offline
        const SAMPLE_METRICS = {
            total: 18450,
            delay: 7200,
            ac: 6100,
            driver: 5150
        };
        const SAMPLE_REGIONS = [
            { region: 'Riyadh', cnt: 5200 },
            { region: 'Makkah', cnt: 4300 },
            { region: 'Eastern Province', cnt: 3800 },
            { region: 'Madinah', cnt: 2100 },
            { region: 'Asir', cnt: 1500 },
            { region: 'Qassim', cnt: 1550 }
        ];

        function showBadge() {
            const badge = document.getElementById('data-badge');
            if (badge) badge.classList.remove('hidden');
        }

        async function init() {
            // 1. Metrics
            let m = await query(`
                SELECT 
                    sum(total_complaints) as total,
                    sumIf(total_complaints, complaint_category = 'Delay') as delay,
                    sumIf(total_complaints, complaint_category = 'Vehicle Condition') as ac,
                    sumIf(total_complaints, complaint_category = 'Driver Behavior') as driver
                FROM support_data_report8_official_complaints_937_rafed
            `);
            
            let usingSample = false;
            if(!m || !m[0]) {
                m = [SAMPLE_METRICS];
                usingSample = true;
            }

            const metrics = m[0];
            document.getElementById('total-complaints').innerText = format(metrics.total);
            let top = 'Delay';
            let max = metrics.delay;
            if(metrics.ac > max) { max = metrics.ac; top = 'Vehicle Condition'; }
            if(metrics.driver > max) { max = metrics.driver; top = 'Driver Behavior'; }
            document.getElementById('top-issue').innerText = top;

            // 2. Map (Aggregated by Region)
            // Hardcoding major Saudi cities for visualization purposes:
            const regionCentroids = {
                'Riyadh': [46.7, 24.7],
                'Makkah': [39.8, 21.4],
                'Eastern Province': [50.1, 26.4],
                'Madinah': [39.6, 24.5],
                'Asir': [42.5, 18.2],
                'Tabuk': [36.5, 28.4],
                'Hail': [41.7, 27.5],
                'Jazan': [42.5, 16.9],
                'Najran': [44.1, 17.5],
                'Al-Bahah': [41.5, 20.0],
                'Al-Jouf': [40.1, 29.8],
                'Northern Borders': [41.0, 30.0],
                'Qassim': [43.9, 26.3]
            };

            let regionData = await query(`
                SELECT region, sum(total_complaints) as cnt 
                FROM support_data_report8_official_complaints_937_rafed 
                GROUP BY region
            `);

            if(!regionData || !regionData.length) {
                regionData = SAMPLE_REGIONS;
                usingSample = true;
            }

            if(regionData) {
                const mapData = regionData.map(d => ({
                    region: d.region,
                    count: d.cnt,
                    coords: regionCentroids[d.region] || [45.0, 24.0] // Default fallback
                }));

                const { MapboxLayer, ScatterplotLayer } = deck;
                
                const map = new maplibregl.Map({
                    container: 'map-container',
                    style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                    center: [45.0, 24.0],
                    zoom: 5,
                    pitch: 0
                });

                map.on('load', () => {
                    const layer = new MapboxLayer({
                        id: 'complaint-bubbles',
                        type: ScatterplotLayer,
                        data: mapData,
                        getPosition: d => d.coords,
                        getFillColor: [239, 68, 68, 200], // Red
                        getRadius: d => Math.sqrt(d.count) * 5000, // Scale radius
                        radiusMinPixels: 10,
                        opacity: 0.6,
                        stroked: true,
                        getLineColor: [255,255,255]
                    });
                    map.addLayer(layer);
                });
            }

            // 3. Charts
            // Category Breakdown
            if(metrics) {
                const d = metrics;
                new Chart(document.getElementById('catChart'), {
                    type: 'pie',
                    data: {
                        labels: ['Delay', 'Vehicle Condition', 'Driver Behavior'],
                        datasets: [{
                            data: [d.delay, d.ac, d.driver],
                            backgroundColor: ['#f59e0b', '#06b6d4', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } }
                    }
                });
            }

            // Region Chart
            if(regionData) {
                new Chart(document.getElementById('regionChart'), {
                    type: 'bar',
                    data: {
                        labels: regionData.map(d => d.region),
                        datasets: [{
                            label: 'Complaints',
                            data: regionData.map(d => d.cnt),
                            backgroundColor: '#06b6d4',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            if (usingSample) showBadge();
        }
        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rafed - Equity & Inclusion</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://unpkg.com/deck.gl@8.9.30/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        .metric-card { @apply p-5 flex flex-col justify-between card h-32; }
        .btn-purple { @apply px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-colors; }
    </style>
</head>
<body class="p-6 h-screen flex flex-col">

    <!-- Header -->
    <header class="flex justify-between items-center mb-6 flex-none">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-purple-600/20">
                <iconify-icon icon="mdi:human-wheelchair" class="text-xl text-white"></iconify-icon>
            </div>
            <div>
                <h1 class="text-xl font-bold text-white tracking-tight">Equity & Inclusion Monitor</h1>
                <p class="text-slate-400 text-xs">Special Needs Access & Low Income Support</p>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="location.reload()" class="btn-purple">Refresh Data</button>
        </div>
    </header>

    <!-- Top Metrics -->
    <div class="grid grid-cols-4 gap-6 mb-6 flex-none">
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Special Needs Students</h3>
            <div class="text-3xl font-bold text-white" id="sn-total">-</div>
            <div class="text-xs text-purple-400 flex gap-1 items-center">
                <iconify-icon icon="mdi:account-check"></iconify-icon> Identified
            </div>
        </div>
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Transport Coverage (SN)</h3>
            <div class="text-3xl font-bold text-white" id="sn-coverage">-%</div>
            <div class="text-xs text-slate-500">Assigned to bus</div>
        </div>
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Low Income Served</h3>
            <div class="text-3xl font-bold text-white" id="low-income-served">-</div>
            <div class="text-xs text-emerald-400">Priority Group</div>
        </div>
        <div class="metric-card">
            <h3 class="text-slate-400 text-xs font-bold uppercase">Avg Distance (Low Income)</h3>
            <div class="text-3xl font-bold text-white" id="low-income-dist">- km</div>
            <div class="text-xs text-slate-500">vs National Avg</div>
        </div>
    </div>

    <!-- Content -->
    <div class="grid grid-cols-3 gap-6 flex-1 min-h-0">
        
        <!-- Left: Map -->
        <div class="col-span-2 card p-1 flex flex-col h-full">
            <div class="p-3 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                <h3 class="font-semibold text-white text-sm flex items-center gap-2">
                    <iconify-icon icon="mdi:map-marker-radius" class="text-purple-500"></iconify-icon>
                    Special Needs Distribution
                </h3>
                <div class="flex gap-3 text-xs">
                    <span class="flex items-center gap-1 text-slate-300"><span class="w-2 h-2 bg-purple-500 rounded-full"></span> Student Location</span>
                </div>
            </div>
            <div class="flex-1 relative rounded-b-lg overflow-hidden">
                <div id="map-container"></div>
            </div>
        </div>

        <!-- Right: Charts -->
        <div class="flex flex-col gap-6 h-full">
            
            <!-- Income Chart -->
            <div class="card p-4 flex-1">
                <h3 class="font-semibold text-white text-sm mb-4">Transport Mode by Income</h3>
                <div class="h-[200px] w-full relative">
                    <canvas id="incomeChart"></canvas>
                </div>
            </div>

            <!-- Disability Types -->
            <div class="card p-4 flex-1">
                <h3 class="font-semibold text-white text-sm mb-4">Disability Types Breakdown</h3>
                <div class="h-[200px] w-full relative">
                    <canvas id="disabilityChart"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        const CH_API = 'http://localhost:8155';
        const AUTH = 'user=viewer&password=rafed_view';

        async function query(sql) {
            try {
                const r = await fetch(`${CH_API}/?${AUTH}&query=${encodeURIComponent(sql + ' FORMAT JSON')}`);
                return await r.json();
            } catch(e) { console.error(e); return null; }
        }

        const format = (n) => Number(n).toLocaleString();

        async function init() {
            // 1. Metrics
            const m = await query(`
                SELECT 
                    countIf(spec_needs IS NOT NULL AND spec_needs != '') as sn_total,
                    countIf(spec_needs IS NOT NULL AND spec_needs != '' AND bus_elig=1) as sn_elig,
                    countIf(income_sar < 5000 AND bus_elig=1) as low_inc_served,
                    avgIf(dist_m, income_sar < 5000)/1000 as low_inc_dist
                FROM students
            `);
            
            if(m && m.data[0]) {
                const d = m.data[0];
                document.getElementById('sn-total').innerText = format(d.sn_total);
                document.getElementById('sn-coverage').innerText = Math.round((d.sn_elig / d.sn_total)*100 || 0) + '%';
                document.getElementById('low-income-served').innerText = format(d.low_inc_served);
                document.getElementById('low-income-dist').innerText = d.low_inc_dist.toFixed(1) + ' km';
            }

            // 2. Map (Special Needs Students)
            const points = await query(`
                SELECT toFloat64(lat) as lat, toFloat64(lon) as lon 
                FROM students 
                WHERE spec_needs IS NOT NULL AND spec_needs != '' AND lat BETWEEN 24.0 AND 25.5
                LIMIT 10000
            `);

            if(points) {
                const { DeckGL, ScatterplotLayer } = deck;
                new DeckGL({
                    container: 'map-container',
                    mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                    initialViewState: { longitude: 46.7, latitude: 24.7, zoom: 10 },
                    controller: true,
                    layers: [
                        new ScatterplotLayer({
                            id: 'sn-points',
                            data: points.data,
                            getPosition: d => [d.lon, d.lat],
                            getFillColor: [147, 51, 234], // Purple
                            getRadius: 50,
                            opacity: 0.9,
                            stroked: true,
                            getLineColor: [255, 255, 255],
                            lineWidthMinPixels: 1
                        })
                    ]
                });
            }

            // 3. Charts
            // Income vs Transport Mode
            const incData = await query(`
                SELECT income_brkt, count() as c 
                FROM students 
                WHERE income_brkt IS NOT NULL 
                GROUP BY income_brkt 
                ORDER BY c DESC
            `);
            
            if(incData) {
                new Chart(document.getElementById('incomeChart'), {
                    type: 'bar',
                    data: {
                        labels: incData.data.map(d => d.income_brkt),
                        datasets: [{
                            label: 'Students',
                            data: incData.data.map(d => d.c),
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // Disability Types
            const disData = await query(`
                SELECT spec_needs, count() as c 
                FROM students 
                WHERE spec_needs IS NOT NULL AND spec_needs != '' 
                GROUP BY spec_needs
            `);
            
            if(disData) {
                new Chart(document.getElementById('disabilityChart'), {
                    type: 'pie',
                    data: {
                        labels: disData.data.map(d => d.spec_needs),
                        datasets: [{
                            data: disData.data.map(d => d.c),
                            backgroundColor: ['#9333ea', '#c084fc', '#e879f9', '#f3e8ff'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } }
                    }
                });
            }
        }
        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rafed Command Center | Analytics Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconify -->
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    
    <!-- MapLibre GL -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- Deck.gl -->
    <script src="https://unpkg.com/deck.gl@8.9.30/dist.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        #map-container { position: relative; height: 600px; width: 100%; border-radius: 0.75rem; overflow: hidden; }
        canvas { width: 100% !important; height: 100% !important; }
    </style>
</head>
<body class="p-6">

    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-600/20">
                <iconify-icon icon="mdi:school" class="text-2xl text-white"></iconify-icon>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-white tracking-tight">Rafed Command Center</h1>
                <p class="text-slate-400 text-sm">National School Transport Analytics</p>
            </div>
        </div>
        <div class="flex gap-3">
            <div class="px-4 py-2 bg-slate-800 rounded-lg text-sm border border-slate-700 flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                System Online
            </div>
            <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors">
                Refresh Data
            </button>
        </div>
    </header>

    <!-- KPI Grid -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- KPI 1 -->
        <div class="card p-5 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <iconify-icon icon="mdi:account-group" class="text-8xl text-blue-500"></iconify-icon>
            </div>
            <h3 class="text-slate-400 text-sm font-medium uppercase tracking-wider mb-1">Total Students</h3>
            <div class="text-3xl font-bold text-white mb-2" id="kpi-students">-</div>
            <div class="text-xs text-emerald-400 flex items-center gap-1">
                <iconify-icon icon="mdi:arrow-up"></iconify-icon>
                <span>12% growth YoY</span>
            </div>
        </div>

        <!-- KPI 2 -->
        <div class="card p-5 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <iconify-icon icon="mdi:bus-school" class="text-8xl text-amber-500"></iconify-icon>
            </div>
            <h3 class="text-slate-400 text-sm font-medium uppercase tracking-wider mb-1">Bus Eligible</h3>
            <div class="text-3xl font-bold text-white mb-2" id="kpi-eligible">-</div>
            <div class="text-xs text-slate-400">
                <span id="kpi-eligible-pct">-</span>% of total population
            </div>
        </div>

        <!-- KPI 3 -->
        <div class="card p-5 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <iconify-icon icon="mdi:school" class="text-8xl text-purple-500"></iconify-icon>
            </div>
            <h3 class="text-slate-400 text-sm font-medium uppercase tracking-wider mb-1">Schools Covered</h3>
            <div class="text-3xl font-bold text-white mb-2" id="kpi-schools">-</div>
            <div class="text-xs text-slate-400">Across 13 Regions</div>
        </div>

        <!-- KPI 4 -->
        <div class="card p-5 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <iconify-icon icon="mdi:alert-circle" class="text-8xl text-rose-500"></iconify-icon>
            </div>
            <h3 class="text-slate-400 text-sm font-medium uppercase tracking-wider mb-1">Waitlist Volume</h3>
            <div class="text-3xl font-bold text-white mb-2" id="kpi-waitlist">-</div>
            <div class="text-xs text-rose-400 flex items-center gap-1">
                <iconify-icon icon="mdi:alert"></iconify-icon>
                <span>Critical Shortage</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]">
        
        <!-- Map Column (2/3 width) -->
        <div class="lg:col-span-2 card p-1 h-full flex flex-col">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-semibold text-white flex items-center gap-2">
                    <iconify-icon icon="mdi:map" class="text-blue-500"></iconify-icon>
                    Student Distribution Heatmap
                </h3>
                <div class="flex gap-2">
                     <span class="text-xs text-slate-400 flex items-center gap-1"><span class="w-2 h-2 bg-blue-500 rounded-full"></span>Boys</span>
                     <span class="text-xs text-slate-400 flex items-center gap-1"><span class="w-2 h-2 bg-pink-500 rounded-full"></span>Girls</span>
                </div>
            </div>
            <div id="map-container" class="flex-1 relative rounded-b-lg overflow-hidden">
                <!-- Map will be injected here -->
            </div>
        </div>

        <!-- Charts Column (1/3 width) -->
        <div class="space-y-6 h-full flex flex-col">
            
            <!-- Chart 1 -->
            <div class="card p-4 flex-1 flex flex-col">
                <h3 class="font-semibold text-white mb-4 text-sm">Eligibility by Gender</h3>
                <div class="flex-1 relative">
                    <canvas id="chart-gender"></canvas>
                </div>
            </div>

            <!-- Chart 2 -->
            <div class="card p-4 flex-1 flex flex-col">
                <h3 class="font-semibold text-white mb-4 text-sm">Top Regions by Demand</h3>
                <div class="flex-1 relative">
                    <canvas id="chart-regions"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Configuration ---
        const CH_API = 'http://localhost:8155'; // ClickHouse HTTP Interface
        const CH_USER = 'viewer';
        const CH_PASS = 'rafed_view';
        
        // --- Helpers ---
        const formatNum = (n) => parseInt(n).toLocaleString('en-US');
        
        async function queryCH(sql) {
            try {
                const url = `${CH_API}/?user=${CH_USER}&password=${CH_PASS}&query=${encodeURIComponent(sql + ' FORMAT JSON')}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('ClickHouse query failed');
                return await response.json();
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        // --- Dashboard Logic ---

        async function loadKPIs() {
            // Parallel fetch for KPIs
            const [students, schools, waitlist] = await Promise.all([
                queryCH('SELECT count() as c, sum(bus_elig) as elig FROM students'),
                queryCH('SELECT count() as c FROM schools'),
                queryCH('SELECT count() as c FROM unassigned_students')
            ]);

            if (students) {
                const total = students.data[0].c;
                const elig = students.data[0].elig;
                document.getElementById('kpi-students').textContent = formatNum(total);
                document.getElementById('kpi-eligible').textContent = formatNum(elig);
                document.getElementById('kpi-eligible-pct').textContent = Math.round((elig / total) * 100);
            }
            if (schools) {
                document.getElementById('kpi-schools').textContent = formatNum(schools.data[0].c);
            }
            if (waitlist) {
                document.getElementById('kpi-waitlist').textContent = formatNum(waitlist.data[0].c);
            }
        }

        async function loadCharts() {
            // Gender Chart
            const genderData = await queryCH('SELECT gender, count() as c FROM students GROUP BY gender');
            if (genderData) {
                const labels = genderData.data.map(d => d.gender);
                const data = genderData.data.map(d => d.c);
                
                new Chart(document.getElementById('chart-gender'), {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ['#3b82f6', '#ec4899'], // Blue, Pink
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } }
                    }
                });
            }

            // Regions Chart
            const regionData = await queryCH('SELECT region_ar, count() as c FROM students GROUP BY region_ar ORDER BY c DESC LIMIT 5');
            if (regionData) {
                new Chart(document.getElementById('chart-regions'), {
                    type: 'bar',
                    data: {
                        labels: regionData.data.map(d => d.region_ar),
                        datasets: [{
                            label: 'Students',
                            data: regionData.data.map(d => d.c),
                            backgroundColor: '#6366f1',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        async function initMap() {
            const { DeckGL, ScatterplotLayer } = deck;

            // Fetch a sample of students for the map (Limit to avoid browser crash on massive datasets)
            // Focus on Riyadh for the initial view
            const points = await queryCH('SELECT toFloat64(lat) as lat, toFloat64(lon) as lon, gender FROM students WHERE lat BETWEEN 24.0 AND 25.5 AND lon BETWEEN 46.0 AND 47.5 LIMIT 25000');
            
            if (!points || !points.data) {
                console.error('No map data found');
                return;
            }
            console.log(`Loaded ${points.data.length} points for map`);

            const map = new DeckGL({
                container: 'map-container',
                mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json', // Free Carto Dark style
                initialViewState: {
                    longitude: 46.7,
                    latitude: 24.7,
                    zoom: 10,
                    pitch: 40,
                    bearing: 0
                },
                controller: true,
                layers: [
                    new ScatterplotLayer({
                        id: 'students-layer',
                        data: points.data,
                        getPosition: d => [d.lon, d.lat],
                        getFillColor: d => d.gender === 'F' ? [236, 72, 153] : [59, 130, 246], // Pink/Blue
                        getRadius: 30,
                        radiusMinPixels: 2,
                        opacity: 0.8
                    })
                ]
            });
        }

        // --- Init ---
        window.refreshData = function() {
            loadKPIs();
            loadCharts();
        };

        // Start
        loadKPIs();
        loadCharts();
        initMap();

    </script>
</body>
</html>
